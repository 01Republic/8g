# F-009-내보내기: Export 프로세스

**상위 문서**: [F-009: Import/Export](../F-009-Import-Export.md)
**최종 수정일**: 2025-11-11

---

## 개요

이 문서는 워크플로우 및 실행 결과 내보내기(Export) 기능의 상세 구현을 설명합니다. JSON, CSV 형식의 다양한 Export 옵션과 클립보드 통합을 다룹니다.

**핵심 기능**:

- 워크플로우 JSON Export
- 실행 결과 CSV Export
- 실행 결과 JSON Export
- 클립보드 복사
- 일괄 Export

---

## 워크플로우 Export

### JSON 형식 Export

**파일명**: `workflow-{id}-{timestamp}.json`
**내용**: FormWorkflow 전체 정의

```typescript
function exportWorkflow(workflow: FormWorkflow, workflowId: number) {
  // 1. Export 데이터 구성
  const data = {
    version: workflow.version,
    start: workflow.start,
    steps: workflow.steps,
    targetUrl: workflow.targetUrl,
    parser: workflow.parser,
    vars: workflow.vars,
  };

  // 2. JSON 문자열 변환 (pretty print)
  const json = JSON.stringify(data, null, 2);

  // 3. Blob 생성
  const blob = new Blob([json], { type: "application/json" });
  const url = URL.createObjectURL(blob);

  // 4. 다운로드
  const link = document.createElement("a");
  link.href = url;
  link.download = `workflow-${workflowId}-${Date.now()}.json`;
  link.click();

  // 5. 메모리 정리
  URL.revokeObjectURL(url);
}
```

### Export 버튼 구현

**파일**: `app/client/admin/workflowBuilder/WorkflowBuilderHeader.tsx`

```typescript
import { Download } from "lucide-react";
import { Button } from "@/components/ui/button";
import { buildWorkflowJson } from "@/models/workflow/WorkflowBuilder";

export function WorkflowBuilderHeader({
  nodes,
  edges,
  targetUrl,
  workflowId
}: {
  nodes: Node[];
  edges: Edge[];
  targetUrl: string;
  workflowId: number;
}) {
  const handleExport = () => {
    // React Flow 그래프 → Workflow JSON 변환
    const workflow = buildWorkflowJson(nodes, edges, targetUrl);

    // Export 실행
    exportWorkflow(workflow, workflowId);

    toast.success("워크플로우를 다운로드했습니다.");
  };

  return (
    <div className="flex items-center justify-between p-4">
      <h1>Workflow Builder</h1>
      <div className="flex gap-2">
        <Button variant="outline" size="sm" onClick={handleExport}>
          <Download className="w-4 h-4 mr-2" />
          Export Workflow
        </Button>
      </div>
    </div>
  );
}
```

---

## 실행 결과 Export

### CSV 형식 Export

**파일명**: `workflow-results-{timestamp}.csv`
**특징**: UTF-8 with BOM (Excel 호환)

```typescript
function exportResultsToCSV(results: WorkflowExecutionResult) {
  // 1. 데이터 추출
  let data: any[];

  if (results.parser) {
    // Parser가 있으면 parser 결과 사용
    data = evaluateParser(results);
  } else {
    // 없으면 마지막 스텝 결과 사용
    const lastStepId = getLastStepId(results);
    data = results.steps[lastStepId]?.result?.data;
  }

  // 2. 데이터 유효성 확인
  if (!Array.isArray(data) || data.length === 0) {
    alert("Export할 데이터가 없습니다.");
    return;
  }

  // 3. CSV 헤더 생성
  const columns = Object.keys(data[0]);
  const csvHeader = columns.join(",");

  // 4. CSV 행 생성
  const csvRows = data.map((row) =>
    columns
      .map((col) => {
        let value = row[col];

        // null/undefined 처리
        if (value === null || value === undefined) {
          return "";
        }

        // 객체/배열은 JSON 문자열로 변환
        if (typeof value === "object") {
          value = JSON.stringify(value);
        }

        // 문자열 이스케이프
        value = String(value);
        if (
          value.includes(",") ||
          value.includes('"') ||
          value.includes("\n")
        ) {
          value = `"${value.replace(/"/g, '""')}"`;
        }

        return value;
      })
      .join(","),
  );

  // 5. UTF-8 BOM 추가 (Excel에서 한글 깨짐 방지)
  const BOM = "\uFEFF";
  const csv = BOM + [csvHeader, ...csvRows].join("\n");

  // 6. 다운로드
  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const link = document.createElement("a");
  link.href = url;
  link.download = `workflow-results-${Date.now()}.csv`;
  link.click();
  URL.revokeObjectURL(url);
}
```

### JSON 형식 Export

**파일명**: `workflow-results-{timestamp}.json`
**내용**: WorkflowExecutionResult 전체

```typescript
function exportResultsToJSON(results: WorkflowExecutionResult) {
  // 1. JSON 문자열 변환
  const json = JSON.stringify(results, null, 2);

  // 2. Blob 생성
  const blob = new Blob([json], { type: "application/json" });
  const url = URL.createObjectURL(blob);

  // 3. 다운로드
  const link = document.createElement("a");
  link.href = url;
  link.download = `workflow-results-${Date.now()}.json`;
  link.click();

  // 4. 메모리 정리
  URL.revokeObjectURL(url);
}
```

### ResultPanel Export 버튼

**파일**: `app/client/admin/workflowBuilder/ResultPanel.tsx`

```typescript
export function ResultPanel({
  results
}: {
  results: WorkflowExecutionResult | null;
}) {
  if (!results) return null;

  return (
    <Card>
      {/* ... 결과 표시 ... */}

      {/* Export 버튼 */}
      <div className="flex gap-2 mt-4">
        <Button
          variant="outline"
          size="sm"
          onClick={() => exportResultsToCSV(results)}
        >
          <Download className="w-4 h-4 mr-2" />
          Export CSV
        </Button>
        <Button
          variant="outline"
          size="sm"
          onClick={() => exportResultsToJSON(results)}
        >
          <Download className="w-4 h-4 mr-2" />
          Export JSON
        </Button>
      </div>
    </Card>
  );
}
```

---

## 클립보드 통합

### 클립보드로 복사

```typescript
async function copyWorkflowToClipboard(workflow: FormWorkflow) {
  const json = JSON.stringify(workflow, null, 2);
  await navigator.clipboard.writeText(json);
  toast.success("워크플로우를 클립보드에 복사했습니다.");
}
```

**키보드 단축키**: Ctrl/Cmd + Shift + C

---

## 향후 개선사항

### Q1 2025

- Export 옵션 UI
- 압축 파일 지원 (ZIP)
- Export 템플릿

### Q2 2025

- Excel 직접 Export (xlsx)
- 일괄 Export/Import UI
- Cloud 동기화

---

## 알려진 이슈

**Issue-001: 대용량 CSV Export 느림**

- **증상**: 10,000개 이상 행 처리 시 지연
- **대안**: 결과를 여러 파일로 분할 Export
- **계획**: Q2 2025 - Web Worker 사용

**Issue-002: Excel에서 UTF-8 인코딩 문제**

- **증상**: 일부 Excel 버전에서 한글 깨짐
- **해결**: UTF-8 BOM 추가로 해결됨
- **상태**: ✅ 해결완료

---

## 관련 문서

- [가져오기 프로세스](./가져오기-프로세스.md) - Import 기능 상세
- [F-008: 결과 시각화](../F-008-결과-시각화.md) - 결과 표시
- [워크플로우 JSON 명세](../../prd/워크플로우-JSON-명세.md) - JSON 구조

---

## 파일 위치

- `app/client/admin/workflowBuilder/WorkflowBuilderHeader.tsx` - Export 버튼
- `app/client/admin/workflowBuilder/ResultPanel.tsx` - CSV/JSON Export
- `app/models/workflow/WorkflowBuilder.ts` - JSON 변환 로직

---

**변경 이력**

| 버전 | 날짜       | 변경 내용      | 작성자 |
| ---- | ---------- | -------------- | ------ |
| 1.0  | 2025-11-11 | 하위 문서 분리 | System |
