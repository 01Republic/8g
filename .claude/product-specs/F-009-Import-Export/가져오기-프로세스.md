# F-009-가져오기: Import 프로세스

**상위 문서**: [F-009: Import/Export](../F-009-Import-Export.md)
**최종 수정일**: 2025-11-11

---

## 개요

이 문서는 워크플로우 가져오기(Import) 기능의 상세 구현을 설명합니다. JSON 형식의 워크플로우 파일을 업로드하고, 검증하고, 로드하는 전체 프로세스를 다룹니다.

**핵심 기능**:
- 파일 업로드 UI
- JSON 파싱 및 검증
- Zod 스키마 검증
- 워크플로우 로드 및 변환
- 에러 처리

---

## Import UI 구현

### WorkflowImportButton 컴포넌트

**파일**: `app/client/admin/workflowBuilder/WorkflowImportButton.tsx`

```typescript
import { useRef } from "react";
import { Button } from "@/components/ui/button";
import { Upload } from "lucide-react";
import { toast } from "sonner";
import { WorkflowSchema } from "./schemas/WorkflowSchema";
import { loadWorkflowFromJSON } from "./utils/workflowLoader";

export function WorkflowImportButton() {
  const fileInputRef = useRef<HTMLInputElement>(null);

  const handleImport = async (event: React.ChangeEvent<HTMLInputElement>) => {
    const file = event.target.files?.[0];
    if (!file) return;

    try {
      // 1. 파일 읽기
      const text = await file.text();

      // 2. JSON 파싱
      let workflow;
      try {
        workflow = JSON.parse(text);
      } catch (error) {
        throw new Error("유효하지 않은 JSON 파일입니다.");
      }

      // 3. 스키마 검증
      const validated = WorkflowSchema.parse(workflow);

      // 4. 워크플로우 로드
      loadWorkflowFromJSON(validated);

      toast.success("워크플로우를 불러왔습니다.");
    } catch (error: any) {
      console.error("Import failed:", error);

      // 에러 메시지 처리
      let message = "워크플로우 불러오기 실패";
      if (error.errors) {
        // Zod 검증 에러
        const issues = error.errors.map((e: any) =>
          `${e.path.join(".")}: ${e.message}`
        ).join("\n");
        message = `워크플로우 구조가 올바르지 않습니다:\n${issues}`;
      } else if (error.message) {
        message = error.message;
      }

      alert(message);
    } finally {
      // 파일 입력 리셋 (같은 파일 재선택 가능)
      if (fileInputRef.current) {
        fileInputRef.current.value = "";
      }
    }
  };

  return (
    <>
      <input
        ref={fileInputRef}
        type="file"
        accept=".json"
        onChange={handleImport}
        className="hidden"
      />
      <Button
        variant="outline"
        size="sm"
        onClick={() => fileInputRef.current?.click()}
      >
        <Upload className="w-4 h-4 mr-2" />
        Import Workflow
      </Button>
    </>
  );
}
```

---

## 스키마 검증

### WorkflowSchema 정의

```typescript
import { z } from "zod";

const BlockSchema = z.object({
  name: z.string(),
}).passthrough();

const StepSchema = z.object({
  id: z.string(),
  block: BlockSchema,
  next: z.string().optional(),
  repeat: z.object({
    forEach: z.string().optional(),
    count: z.union([z.number(), z.string()]).optional(),
  }).optional(),
  switch: z.array(z.any()).optional(),
  delayAfterMs: z.number().optional(),
  retry: z.object({
    attempts: z.number(),
    delayMs: z.number().optional(),
  }).optional(),
  timeoutMs: z.number().optional(),
});

export const WorkflowSchema = z.object({
  version: z.string(),
  start: z.string(),
  steps: z.array(StepSchema),
  targetUrl: z.string().url().optional(),
  parser: z.object({
    expression: z.string(),
  }).optional(),
  vars: z.record(z.any()).optional(),
});

export type FormWorkflow = z.infer<typeof WorkflowSchema>;
```

---

## 검증 로직

### validateWorkflow 함수

```typescript
export function validateWorkflow(data: any): FormWorkflow {
  // 1. Zod 스키마 검증
  const validated = WorkflowSchema.parse(data);

  // 2. 비즈니스 규칙 검증
  validateBusinessRules(validated);

  return validated;
}

function validateBusinessRules(workflow: FormWorkflow): void {
  // 1. 시작 스텝 존재 확인
  const startStep = workflow.steps.find(s => s.id === workflow.start);
  if (!startStep) {
    throw new Error(`시작 스텝을 찾을 수 없습니다: ${workflow.start}`);
  }

  // 2. next 참조 유효성 확인
  const stepIds = new Set(workflow.steps.map(s => s.id));
  for (const step of workflow.steps) {
    if (step.next && !stepIds.has(step.next)) {
      throw new Error(`스텝 ${step.id}의 next가 존재하지 않는 스텝을 참조합니다`);
    }
  }

  // 3. 순환 참조 확인 (DFS)
  detectCircularReferences(workflow);

  // 4. 버전 호환성 확인
  if (workflow.version !== "1.0") {
    console.warn(`지원하지 않는 버전: ${workflow.version}`);
  }
}
```

---

## 워크플로우 로드

### loadWorkflowFromJSON 함수

```typescript
export function loadWorkflowFromJSON(workflow: FormWorkflow) {
  // 1. Workflow → Nodes/Edges 변환
  const { nodes, edges } = convertWorkflowToNodesAndEdges(workflow);

  // 2. Dagre 레이아웃 적용
  const layoutedNodes = applyDagreLayout(nodes, edges);

  // 3. React Flow State 업데이트
  setNodes(layoutedNodes);
  setEdges(edges);

  // 4. 메타데이터 업데이트
  if (workflow.targetUrl) setTargetUrl(workflow.targetUrl);
  if (workflow.vars) setVariables(workflow.vars);
}
```

---

## 에러 처리

### Import 에러 케이스

**1. 잘못된 JSON 형식**
```typescript
try {
  JSON.parse(text);
} catch (error) {
  alert("유효하지 않은 JSON 파일입니다.");
  return;
}
```

**2. 스키마 검증 실패**
```typescript
try {
  WorkflowSchema.parse(workflow);
} catch (error: z.ZodError) {
  const issues = error.issues.map(i =>
    `${i.path.join(".")}: ${i.message}`
  ).join("\n");
  alert(`워크플로우 구조가 올바르지 않습니다:\n${issues}`);
  return;
}
```

**3. 비즈니스 규칙 위반**
```typescript
try {
  validateBusinessRules(workflow);
} catch (error: Error) {
  alert(`워크플로우 검증 실패: ${error.message}`);
  return;
}
```

**4. 호환되지 않는 버전**
```typescript
if (workflow.version !== "1.0") {
  const proceed = confirm(
    `지원하지 않는 워크플로우 버전입니다: ${workflow.version}\n` +
    `계속 진행하시겠습니까? 호환성 문제가 발생할 수 있습니다.`
  );
  if (!proceed) return;
}
```

**5. 파일 읽기 실패**
```typescript
try {
  const text = await file.text();
} catch (error) {
  alert("파일을 읽을 수 없습니다.");
  return;
}
```

---

## 클립보드 통합

### 클립보드에서 붙여넣기

```typescript
async function pasteWorkflowFromClipboard() {
  try {
    const text = await navigator.clipboard.readText();
    const workflow = JSON.parse(text);
    const validated = WorkflowSchema.parse(workflow);
    loadWorkflowFromJSON(validated);
    toast.success("워크플로우를 불러왔습니다.");
  } catch (error: any) {
    alert(`워크플로우 불러오기 실패: ${error.message}`);
  }
}
```

**키보드 단축키**: Ctrl/Cmd + Shift + V

---

## 관련 문서

- [내보내기 프로세스](./내보내기-프로세스.md) - Export 기능 상세
- [F-001: 워크플로우 빌더](../F-001-워크플로우-빌더.md) - 빌더 UI
- [워크플로우 JSON 명세](../../prd/워크플로우-JSON-명세.md) - JSON 구조

---

## 파일 위치

- `app/client/admin/workflowBuilder/WorkflowImportButton.tsx` - Import 버튼
- `app/client/admin/workflowBuilder/schemas/WorkflowSchema.ts` - Zod 스키마
- `app/client/admin/workflowBuilder/utils/workflowLoader.ts` - 로드 로직

---

**변경 이력**

| 버전 | 날짜 | 변경 내용 | 작성자 |
|-----|------|---------|-------|
| 1.0 | 2025-11-11 | 하위 문서 분리 | System |
