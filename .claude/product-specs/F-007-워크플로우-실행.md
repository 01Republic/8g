# F-007: 워크플로우 실행

**기능 ID**: F-007
**우선순위**: P0 (Critical)
**상태**: ✅ 구현완료
**담당**: Integration Team
**최종 수정일**: 2025-11-11

---

## 개요

워크플로우 실행은 설계된 워크플로우를 브라우저 확장(scordi-extension)을 통해 실제 웹사이트에서 실행하는 기능입니다. 변수 치환, 에러 처리, 재시도 로직을 지원하며, 실행 결과를 수집하여 UI에 표시합니다.

**핵심 가치**:

- 실제 브라우저 환경에서 실행
- 안정적인 DOM 조작
- 단계별 결과 수집
- 실시간 진행 상황 표시

---

## 실행 흐름

### 전체 프로세스

```
1. 사용자 "Run" 버튼 클릭
   ↓
2. buildWorkflowJson(nodes, edges, targetUrl)
   ↓
3. 변수 주입 (runtimeVariables)
   ↓
4. EightGClient.collectWorkflow() 호출
   ↓
5. Extension: 새 탭 열기
   ↓
6. Extension: 각 스텝 순차 실행
   ↓
7. Extension: 결과 수집
   ↓
8. UI: ResultPanel에 표시
```

### 코드 구현

```typescript
// app/models/workflow/WorkflowRunner.ts
export async function runWorkflow({
  nodes,
  edges,
  targetUrl,
  variables = {},
}: RunWorkflowParams) {
  // 1. Workflow JSON 빌드
  const workflow = buildWorkflowJson(nodes, edges, targetUrl);

  // 2. 변수 치환
  const finalVars = {
    ...workflow.vars,
    ...variables,
  };

  // 3. targetUrl 변수 치환
  let evaluatedUrl = targetUrl;
  Object.entries(finalVars).forEach(([key, value]) => {
    const regex = new RegExp(`\\$\\{vars\\.${key}\\}`, "g");
    evaluatedUrl = evaluatedUrl.replace(regex, String(value));
  });

  // 4. Extension SDK 호출
  const client = new EightGClient();
  const result = await client.collectWorkflow({
    targetUrl: evaluatedUrl,
    workflow: { ...workflow, vars: finalVars },
    closeTabAfterCollection: true,
    activateTab: true,
  });

  return result;
}
```

---

## Extension SDK

### EightGClient 메서드

**collectWorkflow** - 일반 워크플로우 실행

```typescript
await client.collectWorkflow({
  targetUrl: "https://example.com",
  workflow: workflowJson,
  closeTabAfterCollection: true, // 완료 후 탭 닫기
  activateTab: true, // 실행 중 탭 활성화
});
```

**getWorkspaces** - 워크스페이스 목록

```typescript
await client.getWorkspaces({
  targetUrl: "https://app.example.com",
  workflow: { slug: "my-workspace" },
});
```

**getWorkspaceDetail** - 워크스페이스 상세

```typescript
await client.getWorkspaceDetail(workspaceKey, slug, {
  targetUrl: "https://app.example.com",
});
```

### 확장 확인

```typescript
const client = new EightGClient();
const isInstalled = await client.checkExtension();

if (!isInstalled) {
  alert("8G Extension이 설치되지 않았습니다.");
}
```

---

## 실행 결과 구조

```typescript
interface WorkflowExecutionResult {
  success: boolean;
  context: ExecutionContext;
  steps: {
    [stepId: string]: {
      stepId: string;
      block: Block;
      result: {
        success: boolean;
        data?: any;
        error?: string;
      };
      executionTime: number;
      timestamp: string;
    };
  };
  totalExecutionTime: number;
  completedAt: string;
}
```

### 예시 결과

```json
{
  "success": true,
  "context": {
    "steps": {
      "extract_title": {
        "result": { "data": "Product Name" }
      },
      "extract_price": {
        "result": { "data": "$99.99" }
      }
    }
  },
  "steps": { ... },
  "totalExecutionTime": 2341,
  "completedAt": "2025-11-11T10:30:00Z"
}
```

---

## 에러 처리

### 재시도 로직

```typescript
{
  "id": "api_call",
  "block": { "name": "fetch-api", "url": "..." },
  "retry": {
    "attempts": 3,           // 최대 재시도 횟수
    "delayMs": 1000,        // 재시도 간 지연
    "backoff": "exponential" // 지수 백오프
  }
}
```

### 타임아웃

```typescript
{
  "id": "slow_operation",
  "block": { ... },
  "timeoutMs": 30000  // 30초 타임아웃
}
```

### 에러 분기

```typescript
{
  "id": "risky_step",
  "block": { ... },
  "switch": [
    {
      "when": { "exists": "$.steps.risky_step.result.error" },
      "next": "error_handler"
    }
  ],
  "next": "success_flow"
}
```

---

## UI 컴포넌트

### WorkflowBuilderHeader

```typescript
<WorkflowBuilderHeader>
  <Button
    onClick={handleRunWorkflow}
    disabled={isRunning || !nodes.length}
  >
    {isRunning ? "실행 중..." : "Run Workflow"}
  </Button>
</WorkflowBuilderHeader>
```

### 실행 상태 표시

```typescript
const [isRunning, setIsRunning] = useState(false);
const [executionResults, setExecutionResults] = useState(null);

const handleRunWorkflow = async () => {
  setIsRunning(true);

  try {
    const result = await runWorkflow({
      nodes,
      edges,
      targetUrl,
      variables,
    });

    setExecutionResults(result);
  } catch (error) {
    console.error("Workflow execution failed:", error);
    alert(`실행 실패: ${error.message}`);
  } finally {
    setIsRunning(false);
  }
};
```

---

## 변수 주입

### 런타임 변수 설정

```typescript
<VariablesDialog
  variables={variables}
  onSave={(newVars) => setVariables(newVars)}
>
  <Input name="userId" placeholder="User ID" />
  <Input name="apiKey" placeholder="API Key" type="password" />
</VariablesDialog>
```

### 변수 미리보기

```typescript
<VariablesPreviewPanel variables={variables}>
  <pre>{JSON.stringify(variables, null, 2)}</pre>
</VariablesPreviewPanel>
```

---

## 성능 최적화

### 병렬 실행 (계획)

현재는 순차 실행만 지원하지만, 향후 독립적인 스텝의 병렬 실행 계획:

```typescript
{
  "parallel": [
    { "stepId": "fetch_api1" },
    { "stepId": "fetch_api2" },
    { "stepId": "fetch_api3" }
  ],
  "next": "merge_results"
}
```

### 결과 캐싱 (계획)

동일한 입력에 대한 결과 캐싱으로 실행 시간 단축:

```typescript
{
  "id": "expensive_step",
  "block": { ... },
  "cache": {
    "enabled": true,
    "ttl": 3600  // 1시간
  }
}
```

---

## 알려진 이슈

**Issue-001: 확장 미설치 시 명확한 가이드 부족**

- 에러 메시지만 표시
- 대안: 확장 설치 링크 제공 필요
- 계획: Q1 2025

**Issue-002: 실행 취소 기능 없음**

- 장시간 실행 시 중단 불가
- 대안: 브라우저 탭 직접 닫기
- 계획: Q2 2025

**Issue-003: 실행 히스토리 미저장**

- 이전 실행 결과 확인 불가
- 대안: 수동으로 결과 복사
- 계획: Q2 2025

---

## 향후 개선사항

### Q1 2025

- 실행 취소 기능
- 단계별 진행률 표시
- 확장 설치 가이드 개선

### Q2 2025

- 실행 히스토리 저장
- 병렬 실행 지원
- 실행 스케줄링
- 결과 캐싱

---

## 관련 문서

- [F-001: 비주얼 워크플로우 빌더](./F-001-워크플로우-빌더.md)
- [F-004: 변수 치환](./F-004-변수-치환.md)
- [F-008: 결과 시각화](./F-008-결과-시각화.md)
- [scordi-extension SDK](https://github.com/...)

---

## 파일 위치

- `app/models/workflow/WorkflowRunner.ts`
- `app/client/admin/workflowBuilder/WorkflowBuilderHeader.tsx`
- `scordi-extension` (외부 SDK)

---

**변경 이력**

| 버전 | 날짜       | 변경 내용             | 작성자 |
| ---- | ---------- | --------------------- | ------ |
| 1.0  | 2025-11-11 | 한글 명세서 최초 작성 | System |
