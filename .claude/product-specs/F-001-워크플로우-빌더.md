# F-001: 비주얼 워크플로우 빌더

**기능 ID**: F-001
**우선순위**: P0 (Critical)
**상태**: ✅ 구현완료
**담당**: Frontend Team
**최종 수정일**: 2025-11-11

---

## 개요

비주얼 워크플로우 빌더는 8G 플랫폼의 핵심 기능으로, 사용자가 드래그앤드롭 인터페이스를 통해 웹 자동화 워크플로우를 설계할 수 있게 합니다. React Flow v12 라이브러리 기반으로 구축되어 있으며, 직관적인 그래프 기반 인터페이스를 제공합니다.

**핵심 가치**:

- 코드 작성 없이 워크플로우 구성
- 실시간 유효성 검증
- 무제한 노드 및 엣지 지원
- 자동 레이아웃 기능

---

## 사용자 스토리

### US-001: 워크플로우 생성

**As a** Product Manager
**I want to** 드래그앤드롭으로 워크플로우를 생성하고
**So that** 코드 없이 자동화 로직을 구성할 수 있다

**인수 조건**:

- "Add Block" 버튼 클릭 시 블록 팔레트 열림
- 블록 선택 시 캔버스에 노드 추가
- 노드 드래그로 위치 변경 가능
- 노드 간 연결선 생성 가능
- 워크플로우 저장 가능

### US-002: 복잡한 워크플로우 시각화

**As a** Developer
**I want to** 50개 이상의 노드를 시각화하고
**So that** 전체 로직 흐름을 파악할 수 있다

**인수 조건**:

- 100개 이상 노드 렌더링 지원
- 부드러운 줌 인/아웃
- 미니맵 제공
- 자동 레이아웃 적용 가능

---

## 기술 명세

### 아키텍처

```
WorkflowBuilderPage
├── WorkflowBuilderHeader (툴바)
│   ├── PaletteSheet (블록 선택기)
│   ├── SaveDialog (저장 모달)
│   └── VariablesDialog (변수 편집기)
├── ReactFlow Canvas (메인 캔버스)
│   ├── GenericBlockNode (블록 노드 x N)
│   ├── ConditionalEdge (조건부 엣지 x N)
│   └── Controls (줌/팬 컨트롤)
└── VariablesPreviewPanel (변수 미리보기)
```

### 핵심 컴포넌트

**WorkflowBuilderPage.tsx**

```typescript
export default function WorkflowBuilderPage({ loaderData }) {
  // React Flow 상태 관리
  const [nodes, setNodes, onNodesChange] = useNodesState(initialNodes);
  const [edges, setEdges, onEdgesChange] = useEdgesState(initialEdges);

  // 노드 타입 정의 (모든 블록 타입에 GenericBlockNode 사용)
  const nodeTypes = useMemo(() => workflowNodeTypes, []);

  return (
    <ReactFlow
      nodes={nodes}
      edges={edges}
      onNodesChange={onNodesChange}
      onEdgesChange={onEdgesChange}
      nodeTypes={nodeTypes}
      edgeTypes={{ conditional: ConditionalEdge }}
    >
      <Background />
      <Controls />
      <MiniMap />
    </ReactFlow>
  );
}
```

### 데이터 흐름

**워크플로우 로드**:

```
Route Loader → findWorkflowMetadata(id) → TypeORM Query
  → FormWorkflow JSON → convertWorkflowToNodesAndEdges()
  → { nodes, edges } → React Flow 렌더링
```

**워크플로우 저장**:

```
React Flow State → buildWorkflowJson(nodes, edges, targetUrl)
  → FormWorkflow JSON → Route Action → upsertWorkflowMetadata()
  → MySQL 저장 → 워크플로우 목록으로 리다이렉트
```

---

## API 참조

### Props

```typescript
interface WorkflowBuilderPageProps {
  loaderData: {
    workflowId?: number;
    workflow?: IntegrationAppWorkflowMetadata | null;
    products: Paginated<Product>;
  };
}
```

### 훅

**useWorkflowConfig**

```typescript
const {
  targetUrl,
  setTargetUrl,
  variables,
  setVariables,
  parserConfig,
  setParserConfig,
  buildWorkflow,
} = useWorkflowConfig(nodes, edges, initialTargetUrl);
```

**usePreviousNodes**

```typescript
const previousNodes = usePreviousNodes(nodes, currentNodeId);
// 반환: 현재 노드에서 참조 가능한 이전 노드 배열
```

### 이벤트 핸들러

**onConnect** - 노드 연결

```typescript
const onConnect = useCallback(
  (connection: Connection) => {
    const newEdge = {
      ...connection,
      type: "conditional",
      data: { isDefault: true },
    };
    setEdges((eds) => addEdge(newEdge, eds));
  },
  [setEdges],
);
```

**onNodeDoubleClick** - 블록 설정

```typescript
const onNodeDoubleClick = useCallback((event, node) => {
  setSelectedNode(node);
  setShowBlockModal(true);
}, []);
```

---

## UI/UX 가이드

### 레이아웃 구조

```
┌────────────────────────────────────────────┬─────────────┐
│ [팔레트] [실행] [저장] [자동정렬] [변수] │             │
├────────────────────────────────────────────┤ 변수 패널   │
│                                            │             │
│         React Flow 캔버스                  ├─────────────┤
│                                            │             │
│                                            │ 결과 패널   │
│                                            │             │
└────────────────────────────────────────────┴─────────────┘
```

### 노드 스타일

- **기본**: 흰색 배경, 회색 테두리
- **선택**: 파란색 테두리
- **에러**: 빨간색 테두리
- **실행 중**: 노란색 테두리 + 스피너

### 엣지 스타일

- **기본 엣지**: 실선
- **조건부 엣지**: 점선 + 라벨
- **선택됨**: 굵은 파란색 선

### 키보드 단축키

| 단축키              | 동작                  |
| ------------------- | --------------------- |
| `Delete`            | 선택한 노드/엣지 삭제 |
| `Ctrl/Cmd + S`      | 워크플로우 저장       |
| `Space + Drag`      | 캔버스 팬             |
| `Ctrl/Cmd + Scroll` | 줌 인/아웃            |

---

## 성능 최적화

### 최적화 전략

1. **React Flow 가상화**: 뷰포트 밖 노드 자동 제외
2. **메모이제이션**: `useMemo`로 노드/엣지 타입 캐싱
3. **디바운스**: 자동 레이아웃 300ms 디바운스

### 성능 지표

| 지표                    | 목표    | 현재   |
| ----------------------- | ------- | ------ |
| 초기 렌더링             | < 1s    | ~800ms |
| 노드 추가               | < 100ms | ~50ms  |
| 엣지 연결               | < 50ms  | ~30ms  |
| 자동 레이아웃 (50 노드) | < 2s    | ~1.5s  |

---

## 테스팅 (계획)

### Unit Tests

```typescript
describe('WorkflowBuilderPage', () => {
  it('초기 노드와 엣지를 렌더링해야 함', () => {
    const { container } = render(<WorkflowBuilderPage loaderData={mockData} />);
    expect(container.querySelectorAll('.react-flow__node')).toHaveLength(3);
  });
});
```

### E2E Tests

```typescript
test("워크플로우 생성 플로우", async ({ page }) => {
  await page.goto("/workflow-builder");
  await page.click("text=Add Block");
  await page.click("text=get-text");
  // 블록 설정 및 저장
  await page.click("text=Save");
  await expect(page).toHaveURL("/workflows");
});
```

---

## 알려진 이슈

### High Priority

**Issue-001: Undo/Redo 없음**

- 실수로 삭제 시 복구 불가
- 대안: 페이지 새로고침으로 저장된 버전 복원
- 계획: Q1 2025

**Issue-002: 다중 선택 불가**

- 여러 노드 동시 선택 불가
- 대안: 노드 하나씩 삭제
- 계획: 검토 중

### Medium Priority

**Issue-003: 자동 레이아웃 성능**

- 100개 이상 노드 시 3-5초 소요
- 대안: 수동 레이아웃 사용
- 계획: 최적화 예정

---

## 향후 개선사항

### Q1 2025

- Undo/Redo 기능
- 다중 노드 선택
- 복사/붙여넣기
- 키보드 단축키 확장

### Q2 2025

- 그리드 스냅
- 노드 그룹화
- 워크플로우 템플릿
- 미니맵 개선

---

## 관련 문서

- [F-002: 블록 시스템](./F-002-블록-시스템.md)
- [F-003: 조건부 분기](./F-003-조건부-분기.md)
- [F-010: 자동 레이아웃](./F-010-자동-레이아웃.md)
- [PRD](../PRD.md)

---

## 파일 위치

- `app/client/admin/workflowBuilder/WorkflowBuilderPage.tsx`
- `app/client/admin/workflowBuilder/WorkflowBuilderHeader.tsx`
- `app/client/admin/workflowBuilder/PaletteSheet.tsx`
- `app/models/workflow/WorkflowBuilder.ts`

---

**변경 이력**

| 버전 | 날짜       | 변경 내용             | 작성자 |
| ---- | ---------- | --------------------- | ------ |
| 1.0  | 2025-11-11 | 한글 명세서 최초 작성 | System |
