# F-002: 블록 시스템

**기능 ID**: F-002
**우선순위**: P0 (Critical)
**상태**: ✅ 구현완료
**담당**: Frontend Team + SDK Team
**최종 수정일**: 2025-11-11

---

## 개요

블록 시스템은 8G 워크플로우의 핵심 구성 요소로, 20개 이상의 재사용 가능한 자동화 액션을 제공합니다. **Zod 스키마 기반 UI 자동 생성** 메커니즘을 통해 새로운 블록 타입을 SDK에 추가하기만 하면 UI가 자동으로 생성됩니다.

**핵심 혁신**:

- SDK에 블록 추가 → UI 코드 불필요
- Zod 스키마로 TypeScript 타입 자동 추론
- 런타임 유효성 검증
- 모든 블록이 동일한 UI 패턴 사용

---

## 블록 카테고리

### 1. 데이터 추출 (Data Extraction)

**get-text** - 텍스트 추출

```typescript
{
  name: "get-text",
  selector: ".title",
  findBy: "cssSelector",
  useTextContent: true
}
```

**attribute-value** - 속성값 추출

```typescript
{
  name: "attribute-value",
  selector: "img",
  findBy: "cssSelector",
  attributeName: "src"  // href, data-id 등
}
```

**get-element-data** - 구조화된 데이터 추출

```typescript
{
  name: "get-element-data",
  selector: ".product-card",
  findBy: "cssSelector",
  multiple: true,
  fields: {
    name: { selector: ".product-name" },
    price: { selector: ".product-price" },
    image: { selector: "img", attribute: "src" }
  }
}
```

### 2. 상호작용 (Interaction)

**event-click** - 클릭
**keypress** - 키보드 입력
**scroll** - 스크롤

### 3. 제어 흐름 (Control Flow)

**wait** - 대기
**element-exists** - 요소 존재 확인

### 4. 통합 (Integration)

**fetch-api** - API 호출

```typescript
{
  name: "fetch-api",
  url: "https://api.example.com/users/${vars.userId}",
  method: "GET",
  headers: {
    "Authorization": "Bearer ${vars.apiKey}"
  }
}
```

**ai-parse-data** - AI 데이터 파싱
**transform-data** - JSONata 데이터 변환

```typescript
{
  name: "transform-data",
  sourceData: "$.steps.step1.result.data",
  expression: "items[price > 100].{ name: name, price: price }"
}
```

---

## 스키마 기반 UI 자동 생성

### 핵심 개념

```
SDK (scordi-extension)          Builder UI
──────────────────────          ────────────
Zod 스키마 정의           →      스키마 파싱
                                     ↓
                                 필드 추출
                                     ↓
                                컴포넌트 렌더링
                                     ↓
                                  UI 폼
```

### 구현 방식

**1단계: SDK에서 Zod 스키마 정의**

```typescript
// scordi-extension 패키지
export const GetTextBlockSchema = z.object({
  name: z.literal("get-text"),
  selector: z.string(),
  findBy: z.enum(["cssSelector", "xpath"]),
  useTextContent: z.boolean().optional(),
  option: z
    .object({
      waitForSelector: z.boolean().optional(),
    })
    .optional(),
});

export const AllBlockSchemas = {
  "get-text": GetTextBlockSchema,
  "attribute-value": AttributeValueBlockSchema,
  // ... 20개 이상
};
```

**2단계: UI에서 런타임 스키마 파싱**

```typescript
// app/lib/schema-parser.ts
export function parseZodSchema(schema: ZodTypeAny): ParsedSchema {
  const shape = schema.shape;
  const fields: ParsedField[] = [];

  for (const [fieldName, fieldSchema] of Object.entries(shape)) {
    fields.push({
      name: fieldName,
      type: determineFieldType(fieldSchema),
      optional: fieldSchema.isOptional(),
      enumValues:
        fieldSchema instanceof ZodEnum ? fieldSchema.options : undefined,
    });
  }

  return { fields };
}
```

**3단계: GenericBlockNode로 모든 블록 렌더링**

```typescript
export function GenericBlockNode({ data }: NodeProps) {
  const { block, schema } = data;
  const parsedSchema = useMemo(() => parseZodSchema(schema), [schema]);

  return (
    <div className="block-node">
      {parsedSchema.fields.map(field => {
        switch (field.type) {
          case "string": return <StringFieldBlock field={field} />;
          case "enum": return <EnumFieldBlock field={field} />;
          case "boolean": return <BooleanFieldBlock field={field} />;
          // ... 동적 렌더링
        }
      })}
    </div>
  );
}
```

**4단계: 단일 노드 타입으로 모든 블록 처리**

```typescript
export const workflowNodeTypes: NodeTypes = Object.keys(AllBlockSchemas).reduce(
  (acc, blockName) => {
    acc[blockName] = GenericBlockNode; // 모든 블록이 같은 컴포넌트!
    return acc;
  },
  {},
);
```

### 장점

**새 블록 추가 시 (UI 코드 0줄!)**:

1. SDK에 Zod 스키마 정의
2. `AllBlockSchemas`에 추가
3. (선택) 블록 라벨 추가
4. **완료!** UI 자동 생성

**예시: screenshot 블록 추가**

```typescript
// scordi-extension에만 추가
export const ScreenshotBlockSchema = z.object({
  name: z.literal("screenshot"),
  fullPage: z.boolean().optional(),
  quality: z.number().min(0).max(100).optional(),
  format: z.enum(["png", "jpeg"]).optional(),
});

export const AllBlockSchemas = {
  // ... 기존 블록들
  screenshot: ScreenshotBlockSchema,
};
```

UI가 자동으로:

- `fullPage`: 체크박스 렌더링
- `quality`: 숫자 입력 (0-100 검증)
- `format`: 드롭다운 (png/jpeg)

---

## 필드 블록 컴포넌트

### StringFieldBlock

단일 라인 텍스트 입력

### EnumFieldBlock

드롭다운 선택 (예: `findBy: "cssSelector" | "xpath"`)

### BooleanFieldBlock

체크박스

### ExpressionFieldBlock

JSONata 표현식 + 실시간 테스팅

- 표현식 평가
- 이전 스텝 결과 자동 로드
- 에러 하이라이팅

### SourceDataFieldBlock

이전 스텝 선택 드롭다운

```typescript
<Select value={sourceData}>
  <option value="$.steps.step1.result.data">step1 결과</option>
  <option value="$.steps.step2.result.data">step2 결과</option>
</Select>
```

### RepeatFieldBlock

루프 설정 (forEach 또는 count)

---

## 블록 설정 모달

### BlockActionHandlerModal

```
┌─────────────────────────────────────┐
│ 블록 설정: get-text                 │
├─────────────────────────────────────┤
│ Selector                            │
│ ┌─────────────────────────────────┐ │
│ │ .product-title                  │ │
│ └─────────────────────────────────┘ │
│                                     │
│ Find By                             │
│ ┌─────────────────────────────────┐ │
│ │ cssSelector          ▼          │ │
│ └─────────────────────────────────┘ │
│                                     │
│ ☑ Use Text Content                 │
│                                     │
│         [취소]  [저장]              │
└─────────────────────────────────────┘
```

**기능**:

- 스키마로부터 동적 필드 렌더링
- 실시간 유효성 검증
- 테스트 실행 (expression 블록)
- 중첩 객체 지원

---

## 블록 실행

### 실행 흐름

```
Workflow Runner → 스텝 설정 빌드
  → Extension SDK 전송
  → Extension 워크플로우 수신
  → 각 스텝 순차 실행
  → 결과 수집 및 컨텍스트 저장
  → UI로 결과 반환
```

### 결과 구조

```typescript
interface StepResult {
  stepId: string;
  block: Block;
  result: {
    success: boolean;
    data?: any;
    error?: string;
  };
  executionTime: number;
  timestamp: string;
}
```

---

## 테스팅 (계획)

### Unit Tests

```typescript
describe("parseZodSchema", () => {
  it("문자열 필드를 파싱해야 함", () => {
    const schema = z.object({ name: z.string() });
    const parsed = parseZodSchema(schema);
    expect(parsed.fields[0].type).toBe("string");
  });
});
```

---

## 알려진 이슈

### High Priority

**Issue-001: Zod 내부 API 사용**

- `schema._def`는 공식 API 아님
- Zod 업데이트 시 깨질 가능성
- 대안: `zod-to-json-schema` 패키지 사용
- 계획: Q1 2025

### Medium Priority

**Issue-002: 깊은 중첩 객체**

- 3단계 이상 중첩 시 UI 복잡
- 대안: 구조 평탄화
- 계획: UI 개선

---

## 향후 개선사항

### Q1 2025

- `zod-to-json-schema` 도입
- 중첩 객체 UI 개선
- 배열 필드 지원

### Q2 2025

- 블록 템플릿
- 커스텀 블록 생성 UI
- 블록 마켓플레이스

---

## 관련 문서

- [F-001: 비주얼 워크플로우 빌더](./F-001-워크플로우-빌더.md)
- [F-006: JSONata 테스팅](./F-006-JSONata-테스팅.md)
- [Zod 문서](https://zod.dev/)

---

## 파일 위치

- `app/client/admin/workflowBuilder/nodes/GenericBlockNode.tsx`
- `app/lib/schema-parser.ts`
- `app/client/admin/workflowBuilder/nodes/BlockActionHandlerModal.tsx`
- `scordi-extension` (외부 SDK)

---

**변경 이력**

| 버전 | 날짜       | 변경 내용             | 작성자 |
| ---- | ---------- | --------------------- | ------ |
| 1.0  | 2025-11-11 | 한글 명세서 최초 작성 | System |
