# F-005: 루프 실행 로직

**상위 문서**: [F-005: 루프 설정](../F-005-루프-설정.md)
**최종 수정일**: 2025-11-11

---

## 개요

이 문서는 워크플로우 Extension에서 forEach 및 count 루프가 실제로 어떻게 실행되는지 상세한 로직을 설명합니다.

---

## forEach 실행 로직

### 실행 프로세스

```typescript
async function executeStepWithForEach(
  step: WorkflowStep,
  context: ExecutionContext,
): Promise<StepResult[]> {
  const results: StepResult[] = [];

  // 1. 배열 데이터 조회
  const arrayData = JSONPath.query(context, step.repeat!.forEach!)[0];

  if (!Array.isArray(arrayData)) {
    throw new Error(
      `forEach path did not return an array: ${step.repeat!.forEach}`,
    );
  }

  // 2. 각 아이템에 대해 스텝 실행
  for (let index = 0; index < arrayData.length; index++) {
    const item = arrayData[index];

    // forEach 컨텍스트 설정
    const forEachContext = {
      ...context,
      forEach: {
        item,
        index,
        length: arrayData.length,
      },
    };

    // 스텝 실행
    const result = await executeBlockAction(step.block, forEachContext);

    results.push({
      stepId: step.id,
      iteration: index,
      result,
    });

    // 지연 시간
    if (step.delayAfterMs) {
      await delay(step.delayAfterMs);
    }
  }

  return results;
}
```

### 주요 단계

**1단계: 배열 데이터 조회**

- JSONPath를 사용하여 이전 스텝 결과에서 배열 추출
- 배열이 아닌 경우 에러 발생

**2단계: 컨텍스트 생성**

- 각 반복마다 새로운 컨텍스트 생성
- `$.forEach.item`: 현재 아이템
- `$.forEach.index`: 현재 인덱스 (0부터)
- `$.forEach.length`: 총 아이템 수

**3단계: 블록 실행**

- 각 아이템에 대해 블록 액션 실행
- 실행 결과 수집

**4단계: 지연 처리**

- `delayAfterMs` 설정 시 각 반복 후 대기

---

## count 실행 로직

### 실행 프로세스

```typescript
async function executeStepWithCount(
  step: WorkflowStep,
  context: ExecutionContext,
): Promise<StepResult[]> {
  const results: StepResult[] = [];

  // count 값 결정 (정적 또는 동적)
  const countValue =
    typeof step.repeat!.count === "string"
      ? evaluateExpression(step.repeat!.count, context)
      : step.repeat!.count;

  // 반복 실행
  for (let index = 0; index < countValue; index++) {
    // loop 컨텍스트 설정
    const loopContext = {
      ...context,
      loop: {
        index,
        count: countValue,
      },
    };

    // 스텝 실행
    const result = await executeBlockAction(step.block, loopContext);

    results.push({
      stepId: step.id,
      iteration: index,
      result,
    });

    // 지연 시간
    if (step.delayAfterMs) {
      await delay(step.delayAfterMs);
    }
  }

  return results;
}
```

### 주요 단계

**1단계: count 값 결정**

- 정적 값: 숫자 그대로 사용
- 동적 값: `${vars.varName}` 형식 평가

**2단계: 컨텍스트 생성**

- 각 반복마다 새로운 컨텍스트 생성
- `$.loop.index`: 현재 인덱스 (0부터)
- `$.loop.count`: 총 반복 횟수

**3단계: 블록 실행**

- count 횟수만큼 블록 액션 반복 실행
- 실행 결과 수집

**4단계: 지연 처리**

- `delayAfterMs` 설정 시 각 반복 후 대기

---

## 변수 치환

### forEach 컨텍스트 변수

루프 내에서 사용 가능한 변수:

```typescript
// 현재 아이템 전체
${$.forEach.item}

// 아이템의 특정 속성
${$.forEach.item.name}
${$.forEach.item.url}

// 인덱스 (0부터 시작)
${$.forEach.index}

// 전체 길이
${$.forEach.length}
```

### count 컨텍스트 변수

```typescript
// 현재 인덱스 (0부터 시작)
${$.loop.index}

// 총 반복 횟수
${$.loop.count}

// 실제 페이지 번호 (1부터 시작)
${$.loop.index + 1}
```

---

## 실행 순서

### 일반 루프 (forEach/count)

```
1. 루프 시작
   ↓
2. 컨텍스트 생성 (item/index)
   ↓
3. 변수 치환
   ↓
4. 블록 실행
   ↓
5. 결과 저장
   ↓
6. 지연 대기 (delayAfterMs)
   ↓
7. 다음 반복 또는 종료
```

### 중첩 루프

```
외부 루프 시작
  ↓
  내부 루프 시작
    ↓
    내부 블록 실행
    ↓
  내부 루프 종료
  ↓
외부 루프 다음 반복
```

---

## 관련 문서

- **상위 문서**: [F-005: 루프 설정](../F-005-루프-설정.md)
- **관련 문서**:
  - [루프 사용 예시](./loop-examples.md)
  - [고급 루프 기능](./loop-advanced.md)
  - [F-004: 변수 치환](../F-004-변수-치환.md)

---

**작성자**: Frontend Team
**리뷰 주기**: 분기별
