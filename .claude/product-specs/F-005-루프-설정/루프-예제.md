# 루프 설정 - 실전 예제

**상위 문서**: [F-005: 루프 설정](../F-005-루프-설정.md)
**최종 수정일**: 2025-11-11

---

## 개요

이 문서는 워크플로우 루프 기능의 다양한 실전 활용 예제를 제공합니다. 기본 사용법부터 중첩 루프, 복잡한 데이터 추출까지 단계별로 설명합니다.

---

## 예제 1: 페이지네이션 처리

**시나리오**: 여러 페이지에 걸쳐 있는 상품 목록 추출

### Workflow JSON

```json
{
  "version": "1.0",
  "start": "extract_current_page",
  "targetUrl": "https://example.com/products",
  "steps": [
    {
      "id": "extract_current_page",
      "block": {
        "name": "get-element-data",
        "selector": ".product-item",
        "multiple": true,
        "fields": {
          "name": { "selector": ".product-name" },
          "price": { "selector": ".price" },
          "image": { "selector": "img", "attribute": "src" }
        }
      },
      "next": "click_next"
    },
    {
      "id": "click_next",
      "block": {
        "name": "event-click",
        "selector": ".pagination .next"
      },
      "repeat": {
        "count": 5
      },
      "delayAfterMs": 2000,
      "next": "extract_current_page"
    }
  ]
}
```

### 설명

1. `extract_current_page`: 현재 페이지의 상품 목록 추출
2. `click_next`: "다음" 버튼을 5번 클릭하며 반복
3. `delayAfterMs: 2000`: 페이지 로딩 대기 (2초)
4. 순환 구조: 다시 추출 단계로 돌아감

### 결과 구조

```json
{
  "steps": {
    "extract_current_page": {
      "iterations": [
        { "index": 0, "result": { "data": [...] } },
        { "index": 1, "result": { "data": [...] } },
        ...
      ]
    }
  }
}
```

---

## 예제 2: 링크 목록 순회

**시나리오**: 상품 카드 목록에서 각 상품 상세 페이지 방문 후 정보 추출

### Workflow JSON

```json
{
  "version": "1.0",
  "start": "get_product_links",
  "targetUrl": "https://example.com/products",
  "steps": [
    {
      "id": "get_product_links",
      "block": {
        "name": "get-element-data",
        "selector": ".product-card",
        "multiple": true,
        "fields": {
          "name": { "selector": ".product-name" },
          "url": { "selector": "a", "attribute": "href" },
          "id": { "selector": "[data-product-id]", "attribute": "data-product-id" }
        }
      },
      "next": "visit_each_product"
    },
    {
      "id": "visit_each_product",
      "block": {
        "name": "navigate",
        "url": "${$.forEach.item.url}"
      },
      "repeat": {
        "forEach": "$.steps.get_product_links.result.data"
      },
      "delayAfterMs": 1000,
      "next": "extract_product_details"
    },
    {
      "id": "extract_product_details",
      "block": {
        "name": "get-element-data",
        "selector": ".product-detail",
        "fields": {
          "description": { "selector": ".description" },
          "price": { "selector": ".price" },
          "stock": { "selector": ".stock-status" },
          "rating": { "selector": ".rating-value" }
        }
      }
    }
  ]
}
```

### 설명

1. `get_product_links`: 목록 페이지에서 상품 링크 수집
2. `visit_each_product`: forEach로 각 URL 방문
   - `${$.forEach.item.url}` 사용하여 동적 URL 접근
3. `extract_product_details`: 각 상세 페이지에서 정보 추출

### forEach 컨텍스트 변수 활용

```typescript
// 현재 아이템: $.forEach.item
// 현재 인덱스: $.forEach.index
// 전체 개수: $.forEach.length
```

---

## 예제 3: 중첩 루프 (카테고리 → 상품)

**시나리오**: 카테고리별로 상품 목록 수집

### Workflow JSON

```json
{
  "version": "1.0",
  "start": "get_categories",
  "targetUrl": "https://example.com/categories",
  "steps": [
    {
      "id": "get_categories",
      "block": {
        "name": "get-element-data",
        "selector": ".category",
        "multiple": true,
        "fields": {
          "name": { "selector": ".category-name" },
          "url": { "selector": "a", "attribute": "href" }
        }
      },
      "next": "visit_each_category"
    },
    {
      "id": "visit_each_category",
      "block": {
        "name": "navigate",
        "url": "${$.forEach.item.url}"
      },
      "repeat": {
        "forEach": "$.steps.get_categories.result.data"
      },
      "delayAfterMs": 1500,
      "next": "get_products_in_category"
    },
    {
      "id": "get_products_in_category",
      "block": {
        "name": "get-element-data",
        "selector": ".product",
        "multiple": true,
        "fields": {
          "name": { "selector": ".product-name" },
          "price": { "selector": ".price" }
        }
      },
      "next": "click_each_product"
    },
    {
      "id": "click_each_product",
      "block": {
        "name": "event-click",
        "selector": ".product:nth-child(${$.forEach.index + 1}) .view-details"
      },
      "repeat": {
        "forEach": "$.steps.get_products_in_category.result.data"
      },
      "delayAfterMs": 1000
    }
  ]
}
```

### 중첩 루프 구조

```
외부 루프 (카테고리)
  └─ visit_each_category (forEach: categories)
      └─ get_products_in_category
          └─ 내부 루프 (상품)
              └─ click_each_product (forEach: products)
```

---

## 예제 4: 동적 count 값 사용

**시나리오**: 변수로 반복 횟수 제어

### Workflow JSON

```json
{
  "version": "1.0",
  "start": "scroll_down",
  "targetUrl": "https://example.com/infinite-scroll",
  "vars": {
    "scrollCount": 10
  },
  "steps": [
    {
      "id": "scroll_down",
      "block": {
        "name": "scroll",
        "direction": "down",
        "distance": 500
      },
      "repeat": {
        "count": "${vars.scrollCount}"
      },
      "delayAfterMs": 1000,
      "next": "extract_items"
    },
    {
      "id": "extract_items",
      "block": {
        "name": "get-element-data",
        "selector": ".item",
        "multiple": true
      }
    }
  ]
}
```

### 설명

- `vars.scrollCount`: 워크플로우 실행 시 동적 설정 가능
- Extension 실행 시 변수 치환됨

---

## 예제 5: 인덱스 활용

**시나리오**: 루프 인덱스를 선택자에 활용

### Workflow JSON

```json
{
  "version": "1.0",
  "start": "click_items",
  "targetUrl": "https://example.com/list",
  "steps": [
    {
      "id": "click_items",
      "block": {
        "name": "event-click",
        "selector": ".item:nth-child(${$.loop.index + 1})"
      },
      "repeat": {
        "count": 5
      },
      "delayAfterMs": 500,
      "next": "extract_modal_content"
    },
    {
      "id": "extract_modal_content",
      "block": {
        "name": "get-element-data",
        "selector": ".modal-content"
      }
    }
  ]
}
```

### 설명

- `$.loop.index`: 0부터 시작하는 인덱스
- `nth-child`는 1부터 시작하므로 `+ 1` 필요
- 각 아이템 클릭 후 모달 내용 추출

---

## 예제 6: 조건부 루프 (계획)

**시나리오**: 특정 조건까지만 루프 실행 (향후 기능)

### Workflow JSON (계획)

```json
{
  "version": "1.0",
  "start": "load_more",
  "steps": [
    {
      "id": "load_more",
      "block": {
        "name": "event-click",
        "selector": ".load-more-button"
      },
      "repeat": {
        "count": 100,
        "breakWhen": {
          "equals": {
            "left": "$.steps.load_more.result.buttonExists",
            "right": false
          }
        }
      },
      "delayAfterMs": 2000
    }
  ]
}
```

### 설명 (계획)

- `breakWhen`: 조건 만족 시 루프 조기 종료
- "더보기" 버튼 없을 때까지 반복

---

## 관련 문서

- [F-005: 루프 설정](../F-005-루프-설정.md) - 메인 문서
- [루프 고급 기능](./루프-고급기능.md) - 최적화 및 에러 처리
- [F-005/loop-execution.md](./loop-execution.md) - 실행 로직 상세

---

**문서화 원칙 준수**:
- ✅ 200줄 이하
- ✅ 한글 작성
- ✅ 실전 예제 중심
