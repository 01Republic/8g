# 루프 설정 - 고급 기능

**상위 문서**: [F-005: 루프 설정](../F-005-루프-설정.md)
**최종 수정일**: 2025-11-11

---

## 개요

이 문서는 루프 기능의 고급 활용법, 성능 최적화, 에러 처리 전략을 다룹니다.

---

## 루프 제어 기능

### 조기 종료 (breakWhen - 계획)

**목적**: 특정 조건 만족 시 루프 중단

```typescript
{
  "repeat": {
    "forEach": "$.steps.items.result.data",
    "breakWhen": {
      "equals": {
        "left": "$.forEach.item.status",
        "right": "completed"
      }
    }
  }
}
```

**사용 사례**:
- "더보기" 버튼이 사라질 때까지 클릭
- 특정 상태의 아이템 발견 시 중단
- 목표 데이터 개수 도달 시 종료

---

### 건너뛰기 (skipWhen - 계획)

**목적**: 특정 조건의 반복 건너뜀

```typescript
{
  "repeat": {
    "forEach": "$.steps.items.result.data",
    "skipWhen": {
      "equals": {
        "left": "$.forEach.item.type",
        "right": "disabled"
      }
    }
  }
}
```

**사용 사례**:
- 비활성 아이템 제외
- 이미 처리된 데이터 건너뛰기
- 조건부 필터링

---

## 성능 최적화

### 1. 배치 처리 (계획)

**목적**: 대용량 데이터를 묶어서 처리

```typescript
{
  "repeat": {
    "forEach": "$.steps.large_list.result.data",
    "batchSize": 10,              // 10개씩 묶음
    "delayBetweenBatches": 5000   // 배치 간 5초 대기
  }
}
```

**효과**:
- 서버 부하 분산
- 메모리 효율 향상
- Rate limiting 회피

**예상 구현 시기**: Q2 2025

---

### 2. 병렬 실행 (계획)

**목적**: 독립적인 작업을 동시에 처리

```typescript
{
  "repeat": {
    "forEach": "$.steps.items.result.data",
    "parallel": true,
    "maxConcurrency": 3  // 최대 3개 동시 실행
  }
}
```

**주의사항**:
- DOM 조작은 병렬 실행 불가
- API 호출, 데이터 변환에 적합
- 순서 보장 안됨

**예상 구현 시기**: Q2 2025

---

### 3. 지연 시간 최적화

**전략**: 상황별 적절한 지연 시간 설정

```typescript
// 패턴 1: 빠른 클릭 (DOM 업데이트만)
{
  "delayAfterMs": 100
}

// 패턴 2: 일반 페이지 로딩
{
  "delayAfterMs": 1000
}

// 패턴 3: 느린 API 응답
{
  "delayAfterMs": 3000
}

// 패턴 4: 동적 대기 (계획)
{
  "delayAfterMs": "${vars.dynamicDelay}"
}
```

---

## 에러 처리

### 1. 루프 중 에러 발생

**현재 동작**: 에러 발생 시 루프 즉시 중단

```typescript
{
  "repeat": {
    "forEach": "$.steps.items.result.data"
  },
  "retry": {
    "attempts": 3,
    "delayMs": 1000
  }
}
```

**Retry 로직**:
1. 스텝 실행 실패
2. `attempts` 횟수만큼 재시도
3. 모두 실패 시 루프 중단

---

### 2. 에러 무시 (onError - 계획)

**목적**: 일부 실패해도 계속 진행

```typescript
{
  "repeat": {
    "forEach": "$.steps.items.result.data"
  },
  "onError": "continue"  // "stop" (기본값) 또는 "continue"
}
```

**사용 사례**:
- 일부 상품이 품절이어도 나머지 수집
- 선택적 데이터 추출
- 베스트 에포트 방식

**예상 구현 시기**: Q1 2025

---

### 3. 에러 로깅

```typescript
// 에러 발생 시 결과 구조
{
  "steps": {
    "loop_step": {
      "iterations": [
        {
          "index": 0,
          "result": { "data": "..." }
        },
        {
          "index": 1,
          "error": {
            "message": "Element not found",
            "code": "ELEMENT_NOT_FOUND"
          }
        }
      ]
    }
  }
}
```

---

## 루프 결과 수집

### 결과 접근 패턴

```typescript
// 전체 결과 배열
$.steps.loop_step.result.iterations

// 특정 인덱스 결과
$.steps.loop_step.result.iterations[0].result

// 모든 결과 데이터 추출
$.steps.loop_step.result.iterations[*].result.data

// 성공한 결과만
$.steps.loop_step.result.iterations[?(!error)].result
```

---

### 결과 집계 (transform-data 활용)

```json
{
  "id": "aggregate_results",
  "block": {
    "name": "transform-data",
    "sourceData": "${steps.loop_step.result.iterations}",
    "expression": "$sum(*.result.price)"
  }
}
```

---

## 메모리 관리

### 대용량 루프 주의사항

**문제**: 수천 개 아이템 순회 시 메모리 부족

**해결 방안**:

1. **배치 분할** (계획)
```typescript
{
  "repeat": {
    "forEach": "$.steps.items.result.data",
    "batchSize": 100
  }
}
```

2. **결과 스트리밍** (계획)
```typescript
{
  "repeat": {
    "forEach": "$.steps.items.result.data",
    "streamResults": true  // 중간 결과 즉시 전송
  }
}
```

---

## 디버깅

### Extension 콘솔 로그

```javascript
// 루프 시작
[8G] Starting loop: forEach, 15 items

// 각 반복
[8G] Loop iteration 0/15
[8G] Loop iteration 1/15
...

// 루프 완료
[8G] Loop completed: 15 iterations, 2 errors
```

---

### 진행 상황 추적 (계획)

**UI 개선사항** (Q1 2025):
- 진행률 바 표시
- 현재/전체 카운트
- 예상 완료 시간
- 에러 발생 횟수

```
루프 실행 중: 47/150 (31%)
예상 완료: 약 2분 후
에러: 3건
```

---

## 알려진 제약사항

### 제약 1: 루프 중단 불가

**현상**: 실행 중인 루프를 UI에서 멈출 수 없음

**대안**:
- 브라우저 탭 닫기
- Extension 비활성화

**계획**: Q2 2025 - 중단 버튼 추가

---

### 제약 2: 중첩 깊이 제한

**권장**: 최대 3단계 중첩까지

```typescript
// ✅ 권장
카테고리 (forEach)
  └─ 상품 (forEach)
      └─ 리뷰 (forEach)

// ⚠️ 비권장 (성능 저하)
레벨1 (forEach)
  └─ 레벨2 (forEach)
      └─ 레벨3 (forEach)
          └─ 레벨4 (forEach)
```

---

### 제약 3: 컨텍스트 변수 충돌

**문제**: 중첩 루프에서 내부 루프가 외부 컨텍스트 덮어씀

**현재 동작**: 가장 안쪽 루프의 컨텍스트만 유효

**계획** (Q3 2025): 스택 기반 컨텍스트 관리
```typescript
$.forEach.parent.item  // 외부 루프 아이템
$.forEach.current.item // 현재 루프 아이템
```

---

## 향후 로드맵

### Q1 2025
- ✅ 루프 진행률 UI
- ✅ `onError: "continue"` 옵션
- ✅ 에러 상세 로깅

### Q2 2025
- 🔄 병렬 루프 실행
- 🔄 배치 처리
- 🔄 루프 중단 버튼

### Q3 2025
- 📋 중첩 컨텍스트 관리
- 📋 동적 지연 시간
- 📋 조건부 루프 제어

---

## 관련 문서

- [F-005: 루프 설정](../F-005-루프-설정.md) - 메인 문서
- [루프 예제](./루프-예제.md) - 실전 사용 예시
- [F-005/loop-execution.md](./loop-execution.md) - 실행 로직

---

**문서화 원칙 준수**:
- ✅ 200줄 이하
- ✅ 한글 작성
- ✅ 고급 기능 및 최적화 중심
