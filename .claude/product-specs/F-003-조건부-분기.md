# F-003: 조건부 분기

**기능 ID**: F-003
**우선순위**: P0 (Critical)
**상태**: ✅ 구현완료
**담당**: Frontend Team
**최종 수정일**: 2025-11-11

---

## 개요

조건부 분기는 워크플로우 실행 중 조건에 따라 다른 경로로 분기할 수 있는 기능입니다. JSONPath 표현식과 다양한 비교 연산자를 지원하며, AND/OR 논리 연산자로 복잡한 조건을 구성할 수 있습니다.

**핵심 가치**:
- 동적 워크플로우 구현
- 복잡한 비즈니스 로직 표현
- 에러 처리 분기
- 데이터 기반 의사결정

---

## 조건 타입

### 1. 비교 연산자

**equals** - 동등 비교
```typescript
{
  equals: {
    left: "$.steps.check.result.data",
    right: "success"
  }
}
```

**regex** - 정규표현식 매칭
```typescript
{
  regex: {
    value: "$.steps.extract.result.data",
    pattern: "\\d{3}-\\d{4}"  // 전화번호 패턴
  }
}
```

**contains** - 문자열 포함
```typescript
{
  contains: {
    value: "$.steps.text.result.data",
    search: "에러"
  }
}
```

**exists** - 존재 확인
```typescript
{
  exists: "$.steps.optional.result.data"
}
```

### 2. 논리 연산자

**AND** - 모든 조건 만족
```typescript
{
  and: [
    { equals: { left: "$.steps.auth.result.status", right: "OK" } },
    { exists: "$.steps.auth.result.data.token" }
  ]
}
```

**OR** - 하나 이상 조건 만족
```typescript
{
  or: [
    { equals: { left: "$.steps.status.result.data", right: "success" } },
    { equals: { left: "$.steps.status.result.data", right: "completed" } }
  ]
}
```

### 3. 표현식

**JSONPath** - JSON 경로 표현식
```typescript
"$.steps.list.result.data[0].id"
"$.forEach.item.price"
```

**JSONata** - 데이터 쿼리 및 변환
```typescript
{
  expr: "$sum($.steps.items.result.data.*.price) > 10000"
}
```

---

## 사용 예시

### 예시 1: API 응답 확인
```json
{
  "id": "api_call",
  "block": { "name": "fetch-api", "url": "https://api.com/data" },
  "switch": [
    {
      "when": {
        "equals": {
          "left": "$.steps.api_call.result.data.status",
          "right": "success"
        }
      },
      "next": "process_data"
    },
    {
      "when": {
        "exists": "$.steps.api_call.result.error"
      },
      "next": "handle_error"
    }
  ],
  "next": "default_action"
}
```

### 예시 2: 복합 조건
```json
{
  "switch": [
    {
      "when": {
        "and": [
          {
            "equals": {
              "left": "$.steps.check.result.data.type",
              "right": "premium"
            }
          },
          {
            "regex": {
              "value": "$.steps.check.result.data.email",
              "pattern": "@company\\.com$"
            }
          }
        ]
      },
      "next": "premium_flow"
    }
  ]
}
```

---

## UI 컴포넌트

### EdgeConfigDialog

```
┌──────────────────────────────────┐
│ 엣지 조건 설정                    │
├──────────────────────────────────┤
│ 조건 타입:                       │
│ ┌──────────────────────────────┐ │
│ │ equals            ▼          │ │
│ └──────────────────────────────┘ │
│                                  │
│ Left Value (JSONPath):           │
│ ┌──────────────────────────────┐ │
│ │ $.steps.prev.result.data     │ │
│ └──────────────────────────────┘ │
│                                  │
│ Right Value:                     │
│ ┌──────────────────────────────┐ │
│ │ success                      │ │
│ └──────────────────────────────┘ │
│                                  │
│         [취소]  [저장]           │
└──────────────────────────────────┘
```

### 컴포넌트 구조

```
EdgeConfigDialog
├── ConditionTypeSelector (조건 타입 선택)
├── SingleEquals (단일 equals 조건)
├── SingleRegex (단일 regex 조건)
├── SingleContains (단일 contains 조건)
├── SingleExists (단일 exists 조건)
└── Multiple (AND/OR 복합 조건)
    └── ConditionList (재귀적 조건 목록)
```

---

## 기술 명세

### Strategy 패턴

```typescript
// 조건 전략 인터페이스
interface ConditionStrategy {
  validate(data: any): boolean;
  build(data: any): WhenCondition;
  parse(condition: WhenCondition): any;
}

// Equals 전략
class EqualsStrategy implements ConditionStrategy {
  validate(data) {
    return !!data.left && data.right !== undefined;
  }

  build(data) {
    return { equals: { left: data.left, right: data.right } };
  }

  parse(condition) {
    return condition.equals;
  }
}

// 전략 레지스트리
const strategies = new Map<string, ConditionStrategy>();
strategies.set("equals", new EqualsStrategy());
strategies.set("regex", new RegexStrategy());
// ...
```

### 데이터 구조

```typescript
interface WhenCondition {
  // 비교 연산자
  equals?: { left: string; right: any };
  regex?: { value: string; pattern: string };
  contains?: { value: string; search: string };
  exists?: string;

  // 논리 연산자 (재귀)
  and?: WhenCondition[];
  or?: WhenCondition[];

  // 표현식
  expr?: string;
}
```

---

## 조건 평가 (Extension)

```typescript
function evaluateCondition(condition: WhenCondition, context: any): boolean {
  // AND 논리
  if (condition.and) {
    return condition.and.every(c => evaluateCondition(c, context));
  }

  // OR 논리
  if (condition.or) {
    return condition.or.some(c => evaluateCondition(c, context));
  }

  // equals 비교
  if (condition.equals) {
    const leftValue = JSONPath.query(context, condition.equals.left)[0];
    return leftValue === condition.equals.right;
  }

  // exists 확인
  if (condition.exists) {
    const result = JSONPath.query(context, condition.exists);
    return result.length > 0 && result[0] !== null && result[0] !== undefined;
  }

  // ... 기타 조건 평가

  return false;
}
```

---

## 조건 렌더링

```typescript
// 조건을 사람이 읽을 수 있는 형태로 표시
export function renderCondition(condition: WhenCondition): string {
  if (condition.equals) {
    return `${condition.equals.left} == ${condition.equals.right}`;
  }

  if (condition.and) {
    return condition.and.map(renderCondition).join(" AND ");
  }

  if (condition.or) {
    return condition.or.map(renderCondition).join(" OR ");
  }

  // ...
}
```

---

## 알려진 이슈

**Issue-001: JSONPath 표현식 자동완성 없음**
- 사용자가 경로를 수동 입력해야 함
- 대안: 이전 스텝 결과 구조 참고
- 계획: Q2 2025

**Issue-002: 조건 테스트 기능 없음**
- 조건이 올바른지 미리 확인 불가
- 대안: 워크플로우 실행으로 검증
- 계획: Q1 2025

---

## 향후 개선사항

### Q1 2025
- 조건 테스트 UI
- JSONPath 자동완성
- 조건 템플릿

### Q2 2025
- 시각적 조건 빌더
- 복잡한 표현식 지원 확대
- 조건 디버깅 도구

---

## 관련 문서

- [F-001: 비주얼 워크플로우 빌더](./F-001-워크플로우-빌더.md)
- [F-004: 변수 치환](./F-004-변수-치환.md)
- [JSONPath 문서](https://goessner.net/articles/JsonPath/)

---

## 파일 위치

- `app/client/admin/workflowBuilder/edges/EdgeConfigDialog/`
- `app/client/admin/workflowBuilder/utils/conditionUtils.ts`
- `app/client/admin/workflowBuilder/edges/ConditionalEdge.tsx`

---

**변경 이력**

| 버전 | 날짜 | 변경 내용 | 작성자 |
|-----|------|---------|-------|
| 1.0 | 2025-11-11 | 한글 명세서 최초 작성 | System |
