# F-004: 변수 치환

**기능 ID**: F-004
**우선순위**: P0 (Critical)
**상태**: ✅ 구현완료
**담당**: Frontend Team
**최종 수정일**: 2025-11-11

---

## 개요

변수 치환은 워크플로우 실행 시 동적 데이터를 주입할 수 있는 기능입니다. 정적 변수, 동적 변수(JSONPath), 컨텍스트 변수를 지원하며, 템플릿 문자열 형태로 블록 설정에 사용할 수 있습니다.

**핵심 가치**:
- 워크플로우 재사용성 향상
- 동적 데이터 처리
- 이전 스텝 결과 참조
- 루프 컨텍스트 접근

---

## 변수 타입

### 1. 정적 변수

**정의**: `workflow.vars` 객체에 직접 정의된 고정 값

**사용법**:
```typescript
{
  "vars": {
    "email": "user@example.com",
    "password": "secure123",
    "apiKey": "abc123xyz"
  }
}
```

**치환 문법**:
```typescript
// 블록 설정에서 사용
{
  "block": {
    "name": "keypress",
    "selector": "#email",
    "value": "${vars.email}"  // → "user@example.com"
  }
}
```

**활용 사례**:
- 로그인 자격 증명
- API 키
- 공통 URL
- 고정 파라미터

---

### 2. 동적 변수 (JSONPath)

**정의**: 이전 스텝 실행 결과를 참조하는 표현식

**사용법**:
```typescript
// 이전 스텝 결과 참조
"$.steps.extract_id.result.data"

// 배열 요소 접근
"$.steps.get_list.result.data[0].id"

// 필터링
"$.steps.get_list.result.data[?(@.status == 'active')]"
```

**치환 예시**:
```typescript
{
  "id": "get_details",
  "block": {
    "name": "fetch-api",
    "url": "https://api.com/users/${$.steps.get_id.result.data}"
  }
}
```

**JSONPath 문법**:
- `$` - 루트
- `.steps.step_id` - 스텝 접근
- `.result.data` - 결과 데이터
- `[0]` - 배열 인덱스
- `[?(@.key == 'value')]` - 필터

---

### 3. 컨텍스트 변수

**정의**: 루프 실행 시 자동으로 제공되는 변수

**forEach 컨텍스트**:
```typescript
{
  "repeat": {
    "forEach": "$.steps.get_list.result.data"
  },
  "block": {
    "name": "event-click",
    "selector": "${$.forEach.item.selector}"  // 현재 아이템
  }
}
```

**count 루프 컨텍스트**:
```typescript
{
  "repeat": {
    "count": 5
  },
  "block": {
    "name": "keypress",
    "value": "Item ${$.loop.index}"  // 0, 1, 2, 3, 4
  }
}
```

**사용 가능한 컨텍스트 변수**:
- `$.forEach.item` - 현재 순회 중인 아이템
- `$.forEach.index` - 현재 인덱스 (0부터 시작)
- `$.loop.index` - count 루프 인덱스
- `$.loop.count` - 총 루프 횟수

---

## 변수 설정 UI

### VariablesDialog 컴포넌트

```typescript
export function VariablesDialog({
  variables,
  onSave
}: {
  variables: Record<string, any>;
  onSave: (vars: Record<string, any>) => void;
}) {
  const [vars, setVars] = useState(variables);

  return (
    <Dialog>
      <DialogTrigger>
        <Button>Variables</Button>
      </DialogTrigger>
      <DialogContent>
        <DialogHeader>
          <DialogTitle>워크플로우 변수 설정</DialogTitle>
        </DialogHeader>
        <div className="space-y-4">
          {Object.entries(vars).map(([key, value]) => (
            <div key={key}>
              <Label>{key}</Label>
              <Input
                value={value}
                onChange={(e) => {
                  setVars({ ...vars, [key]: e.target.value });
                }}
              />
            </div>
          ))}
          <Button
            onClick={() => {
              const newKey = prompt("변수 이름:");
              if (newKey) {
                setVars({ ...vars, [newKey]: "" });
              }
            }}
          >
            + 변수 추가
          </Button>
        </div>
        <DialogFooter>
          <Button onClick={() => onSave(vars)}>저장</Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}
```

---

## 변수 치환 구현

### 클라이언트 사이드 (UI)

**파일**: `app/models/workflow/WorkflowRunner.ts`

```typescript
export async function runWorkflow({
  nodes,
  edges,
  targetUrl,
  variables = {}
}: RunWorkflowParams) {
  // 1. Workflow JSON 빌드
  const workflow = buildWorkflowJson(nodes, edges, targetUrl);

  // 2. 변수 병합 (런타임 변수 우선)
  const finalVars = {
    ...workflow.vars,
    ...variables
  };

  // 3. targetUrl 변수 치환
  let evaluatedUrl = targetUrl;
  Object.entries(finalVars).forEach(([key, value]) => {
    const regex = new RegExp(`\\$\\{vars\\.${key}\\}`, "g");
    evaluatedUrl = evaluatedUrl.replace(regex, String(value));
  });

  // 4. Extension SDK 호출 (나머지 치환은 Extension에서 처리)
  const client = new EightGClient();
  const result = await client.collectWorkflow({
    targetUrl: evaluatedUrl,
    workflow: { ...workflow, vars: finalVars },
    closeTabAfterCollection: true
  });

  return result;
}
```

### Extension 사이드 (실행)

**변수 치환 로직** (scordi-extension 내부):

```typescript
function substituteVariables(
  text: string,
  context: ExecutionContext
): string {
  // 1. 정적 변수 치환 (${vars.varName})
  text = text.replace(/\$\{vars\.(\w+)\}/g, (match, varName) => {
    return context.workflow.vars?.[varName] ?? match;
  });

  // 2. 동적 변수 치환 (${$.steps.xxx})
  text = text.replace(/\$\{(\$.+?)\}/g, (match, jsonPath) => {
    const result = JSONPath.query(context, jsonPath);
    return result[0] ?? match;
  });

  // 3. forEach 컨텍스트 치환
  if (context.forEach) {
    text = text.replace(/\$\{\.forEach\.item(\.[\w.]+)?\}/g, (match, path) => {
      if (!path) return context.forEach.item;
      const result = JSONPath.query(context.forEach.item, `$${path}`);
      return result[0] ?? match;
    });

    text = text.replace(/\$\{\.forEach\.index\}/g, () => {
      return String(context.forEach.index);
    });
  }

  // 4. loop 컨텍스트 치환
  if (context.loop) {
    text = text.replace(/\$\{\.loop\.index\}/g, () => {
      return String(context.loop.index);
    });
  }

  return text;
}
```

---

## 사용 예시

### 예시 1: 로그인 자동화

```json
{
  "vars": {
    "email": "user@example.com",
    "password": "mypassword"
  },
  "steps": [
    {
      "id": "enter_email",
      "block": {
        "name": "keypress",
        "selector": "#email",
        "value": "${vars.email}"
      }
    },
    {
      "id": "enter_password",
      "block": {
        "name": "keypress",
        "selector": "#password",
        "value": "${vars.password}"
      }
    }
  ]
}
```

---

### 예시 2: API 연계

```json
{
  "steps": [
    {
      "id": "get_user_id",
      "block": {
        "name": "get-text",
        "selector": "#user-id"
      },
      "next": "fetch_user_details"
    },
    {
      "id": "fetch_user_details",
      "block": {
        "name": "fetch-api",
        "url": "https://api.com/users/${$.steps.get_user_id.result.data}",
        "method": "GET"
      }
    }
  ]
}
```

---

### 예시 3: forEach 루프

```json
{
  "steps": [
    {
      "id": "get_product_list",
      "block": {
        "name": "get-element-data",
        "selector": ".product",
        "multiple": true,
        "fields": {
          "name": { "selector": ".name" },
          "url": { "selector": "a", "attribute": "href" }
        }
      },
      "next": "visit_each_product"
    },
    {
      "id": "visit_each_product",
      "block": {
        "name": "navigate",
        "url": "${$.forEach.item.url}"
      },
      "repeat": {
        "forEach": "$.steps.get_product_list.result.data"
      }
    }
  ]
}
```

---

## 변수 미리보기

### VariablesPreviewPanel

```typescript
export function VariablesPreviewPanel({
  variables
}: {
  variables: Record<string, any>;
}) {
  return (
    <Card className="p-4">
      <h3 className="font-semibold mb-2">현재 변수</h3>
      <div className="space-y-1 text-sm">
        {Object.entries(variables).map(([key, value]) => (
          <div key={key} className="flex justify-between">
            <span className="text-muted-foreground">{key}:</span>
            <span className="font-mono">
              {typeof value === "string" && value.length > 30
                ? `${value.substring(0, 30)}...`
                : String(value)}
            </span>
          </div>
        ))}
      </div>
    </Card>
  );
}
```

---

## 보안 고려사항

### 민감 정보 처리

```typescript
// 향후 구현 계획: 변수 암호화 저장
export interface SecureVariable {
  key: string;
  value: string;
  encrypted: boolean;  // true면 암호화된 값
  type: "password" | "apiKey" | "token";
}

// UI에서 비밀번호 타입으로 표시
<Input
  type={variable.type === "password" ? "password" : "text"}
  value={variable.value}
/>
```

### 변수 유효성 검증

```typescript
// 변수 이름 규칙
const VARIABLE_NAME_REGEX = /^[a-zA-Z_][a-zA-Z0-9_]*$/;

function validateVariableName(name: string): boolean {
  return VARIABLE_NAME_REGEX.test(name);
}

// 순환 참조 감지 (향후)
function detectCircularReference(
  workflow: FormWorkflow
): boolean {
  // 변수가 다른 변수를 참조하는 경우 순환 참조 검증
  return false;
}
```

---

## 알려진 이슈

**Issue-001: 변수 자동완성 없음**
- JSONPath 표현식 수동 입력 필요
- 대안: 이전 스텝 결과 구조 참고
- 계획: Q2 2025

**Issue-002: 변수 디버깅 어려움**
- 치환된 값 확인 불가
- 대안: Extension 콘솔 로그 확인
- 계획: Q1 2025 - 변수 디버깅 패널

---

## 향후 개선사항

### Q1 2025
- 변수 디버깅 패널
- 치환 결과 미리보기
- 변수 유효성 검증 강화

### Q2 2025
- JSONPath 자동완성
- 변수 암호화 저장
- 글로벌 변수 지원
- 변수 템플릿 라이브러리

---

## 관련 문서

- [F-001: 워크플로우 빌더](./F-001-워크플로우-빌더.md)
- [F-005: 루프 설정](./F-005-루프-설정.md)
- [F-007: 워크플로우 실행](./F-007-워크플로우-실행.md)

---

## 파일 위치

- `app/models/workflow/WorkflowRunner.ts`
- `app/client/admin/workflowBuilder/VariablesDialog.tsx`
- `scordi-extension` (변수 치환 로직)

---

**변경 이력**

| 버전 | 날짜 | 변경 내용 | 작성자 |
|-----|------|---------|-------|
| 1.0 | 2025-11-11 | 최초 작성 | System |
