# 스텝 정의

**문서 버전**: 1.0
**최종 수정일**: 2025-11-11
**상위 문서**: [워크플로우 JSON 명세](../워크플로우-JSON-명세.md)

---

## 개요

이 문서는 워크플로우 스텝(WorkflowStep)의 구조와 블록(Block) 설정을 상세히 정의합니다.

---

## WorkflowStep 구조

```typescript
interface WorkflowStep {
  id: string; // 고유 스텝 ID
  block: Block; // 실행할 블록
  repeat?: RepeatConfig; // 반복 설정
  switch?: SwitchCase[]; // 조건부 분기
  next?: string; // 다음 스텝 ID (기본 경로)
  delayAfterMs?: number; // 실행 후 대기 시간 (ms)
  retry?: RetryConfig; // 재시도 설정
  timeoutMs?: number; // 타임아웃 (ms)
}
```

---

## 필수 필드

### id (string)

워크플로우 내 고유 식별자입니다.

**규칙**:

- 워크플로우 내에서 고유해야 함
- 영문자, 숫자, 언더스코어 사용 권장
- 예: `extract_data`, `step_001`, `login_action`

---

### block (Block)

실행할 액션을 정의합니다.

```typescript
interface Block {
  name: string; // 블록 타입명
  [key: string]: any; // 블록별 설정
}
```

---

## 선택 필드

### next (string)

기본 다음 스텝 ID를 지정합니다.

**예시**:

```json
{
  "id": "step_1",
  "block": { "name": "event-click", "selector": "button" },
  "next": "step_2"
}
```

**참고**:

- `next`가 없으면 워크플로우 종료
- `switch` 조건과 함께 사용 시 기본 경로로 동작

---

### delayAfterMs (number)

스텝 실행 후 대기 시간(밀리초)입니다.

**예시**:

```json
{
  "id": "click_button",
  "block": { "name": "event-click", "selector": "button" },
  "delayAfterMs": 2000,
  "next": "check_result"
}
```

**사용 사례**:

- 페이지 로딩 대기
- 애니메이션 완료 대기
- API 응답 대기

---

### timeoutMs (number)

스텝 최대 실행 시간(밀리초)입니다.

**예시**:

```json
{
  "id": "wait_for_element",
  "block": { "name": "element-exists", "selector": ".result" },
  "timeoutMs": 5000
}
```

**기본값**: 시스템 기본값 (일반적으로 30초)

---

## Block 타입

### 데이터 추출 블록

#### get-text

텍스트 추출 블록입니다.

```json
{
  "name": "get-text",
  "selector": ".product-title",
  "findBy": "cssSelector",
  "useTextContent": true
}
```

**필드**:

- `selector`: CSS 선택자 또는 XPath
- `findBy`: "cssSelector" | "xpath"
- `useTextContent`: true (textContent) | false (innerText)

---

#### attribute-value

HTML 속성 값 추출 블록입니다.

```json
{
  "name": "attribute-value",
  "selector": "img.product-image",
  "findBy": "cssSelector",
  "attribute": "src"
}
```

**필드**:

- `selector`: CSS 선택자 또는 XPath
- `findBy`: "cssSelector" | "xpath"
- `attribute`: 추출할 속성명 (예: "src", "href", "data-id")

---

#### get-element-data

구조화된 데이터 추출 블록입니다.

```json
{
  "name": "get-element-data",
  "selector": ".product",
  "findBy": "cssSelector",
  "multiple": true,
  "fields": {
    "name": { "selector": ".product-name" },
    "price": { "selector": ".product-price" },
    "image": { "selector": "img", "attribute": "src" }
  }
}
```

**필드**:

- `selector`: 루트 요소 선택자
- `findBy`: "cssSelector" | "xpath"
- `multiple`: true (배열 반환) | false (단일 객체)
- `fields`: 추출할 필드 정의

---

#### get-value-form

폼 입력 값 추출 블록입니다.

```json
{
  "name": "get-value-form",
  "selector": "#email-input",
  "findBy": "cssSelector"
}
```

---

### 인터랙션 블록

#### event-click

클릭 이벤트 블록입니다.

```json
{
  "name": "event-click",
  "selector": "button[type=submit]",
  "findBy": "cssSelector"
}
```

---

#### keypress

키보드 입력 블록입니다.

```json
{
  "name": "keypress",
  "selector": "#email",
  "findBy": "cssSelector",
  "value": "${vars.email}"
}
```

**필드**:

- `selector`: 입력 필드 선택자
- `findBy`: "cssSelector" | "xpath"
- `value`: 입력할 값 (변수 치환 지원)

---

#### scroll

스크롤 제어 블록입니다.

```json
{
  "name": "scroll",
  "direction": "down",
  "amount": 500
}
```

**필드**:

- `direction`: "up" | "down" | "left" | "right"
- `amount`: 스크롤 픽셀 수

---

### 제어 흐름 블록

#### wait

대기 블록입니다.

```json
{
  "name": "wait",
  "duration": 3000
}
```

**필드**:

- `duration`: 대기 시간 (밀리초)

---

#### element-exists

요소 존재 확인 블록입니다.

```json
{
  "name": "element-exists",
  "selector": ".dashboard",
  "findBy": "cssSelector"
}
```

**반환값**:

```json
{
  "exists": true,
  "element": {
    /* 요소 정보 */
  }
}
```

---

### 통합 블록

#### fetch-api

HTTP API 호출 블록입니다.

```json
{
  "name": "fetch-api",
  "url": "https://api.example.com/data",
  "method": "GET",
  "headers": {
    "Authorization": "Bearer ${vars.apiKey}"
  }
}
```

**필드**:

- `url`: API 엔드포인트 (변수 치환 지원)
- `method`: "GET" | "POST" | "PUT" | "DELETE" | "PATCH"
- `headers`: HTTP 헤더 (선택)
- `body`: 요청 본문 (선택, POST/PUT/PATCH)

---

#### transform-data

JSONata 데이터 변환 블록입니다.

```json
{
  "name": "transform-data",
  "sourceData": "$.steps.api_call.result.data",
  "expression": "items[price > 100].{ name: name, price: price }"
}
```

**필드**:

- `sourceData`: JSONPath 표현식으로 소스 데이터 지정
- `expression`: JSONata 변환 표현식

---

## 관련 문서

- [워크플로우 JSON 명세](../워크플로우-JSON-명세.md)
- [고급 기능](./고급-기능.md)
- [F-002: 블록 시스템](../../product-specs/F-002-블록-시스템.md)

---

**변경 이력**

| 버전 | 날짜       | 변경 내용                               | 작성자 |
| ---- | ---------- | --------------------------------------- | ------ |
| 1.0  | 2025-11-11 | 워크플로우 JSON 명세에서 스텝 정의 분리 | System |
