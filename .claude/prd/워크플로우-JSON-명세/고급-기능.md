# 고급 기능

**문서 버전**: 1.0
**최종 수정일**: 2025-11-11
**상위 문서**: [워크플로우 JSON 명세](../워크플로우-JSON-명세.md)

---

## 개요

이 문서는 워크플로우의 고급 기능(repeat, switch, retry, parser, vars)을 상세히 설명합니다.

---

## RepeatConfig (반복)

```typescript
interface RepeatConfig {
  forEach?: string; // JSONPath to array
  count?: number | string; // Fixed count or variable
}
```

---

### forEach 루프

배열을 순회하며 스텝을 반복 실행합니다.

**예시**:

```json
{
  "id": "process_item",
  "block": {
    "name": "event-click",
    "selector": ".item-${$.forEach.index}"
  },
  "repeat": {
    "forEach": "$.steps.get_list.result.data"
  }
}
```

**컨텍스트 변수**:

- `$.forEach.item`: 현재 아이템
- `$.forEach.index`: 현재 인덱스 (0부터 시작)
- `$.forEach.array`: 전체 배열

---

### count 루프

고정 횟수만큼 스텝을 반복 실행합니다.

**예시 (고정 횟수)**:

```json
{
  "id": "scroll_down",
  "block": {
    "name": "scroll",
    "direction": "down",
    "amount": 500
  },
  "repeat": {
    "count": 5
  }
}
```

**예시 (변수 참조)**:

```json
{
  "repeat": {
    "count": "${vars.pageCount}"
  }
}
```

**컨텍스트 변수**:

- `$.loop.index`: 현재 반복 인덱스 (0부터 시작)
- `$.loop.count`: 전체 반복 횟수

---

## SwitchCase (조건부 분기)

```typescript
interface SwitchCase {
  when: WhenCondition; // 조건
  next: string; // 조건 만족 시 다음 스텝
}
```

---

### WhenCondition

```typescript
interface WhenCondition {
  // 비교 연산자
  equals?: {
    left: string; // JSONPath 표현식
    right: any; // 비교 값
  };
  regex?: {
    value: string; // JSONPath 표현식
    pattern: string; // 정규표현식
  };
  contains?: {
    value: string; // JSONPath 표현식
    search: string; // 검색 문자열
  };
  exists?: string; // JSONPath 표현식

  // 논리 연산자
  and?: WhenCondition[]; // AND 조건 배열
  or?: WhenCondition[]; // OR 조건 배열

  // 표현식
  expr?: string; // JSONata 표현식
}
```

---

### equals 조건

값 동등 비교입니다.

**예시**:

```json
{
  "switch": [
    {
      "when": {
        "equals": {
          "left": "$.steps.check.result.data.status",
          "right": "success"
        }
      },
      "next": "process_success"
    }
  ],
  "next": "default_handler"
}
```

---

### regex 조건

정규표현식 매칭입니다.

**예시**:

```json
{
  "when": {
    "regex": {
      "value": "$.steps.check.result.error.message",
      "pattern": "timeout|connection"
    }
  },
  "next": "handle_network_error"
}
```

---

### contains 조건

문자열 포함 확인입니다.

**예시**:

```json
{
  "when": {
    "contains": {
      "value": "$.steps.get_text.result.data",
      "search": "Error"
    }
  },
  "next": "handle_error"
}
```

---

### exists 조건

값 존재 확인입니다.

**예시**:

```json
{
  "when": {
    "exists": "$.steps.check.result.error"
  },
  "next": "handle_error"
}
```

---

### AND/OR 논리 연산자

복합 조건을 구성합니다.

**AND 예시**:

```json
{
  "when": {
    "and": [
      {
        "exists": "$.steps.check.result.error"
      },
      {
        "regex": {
          "value": "$.steps.check.result.error.message",
          "pattern": "timeout"
        }
      }
    ]
  },
  "next": "handle_timeout"
}
```

**OR 예시**:

```json
{
  "when": {
    "or": [
      {
        "equals": {
          "left": "$.steps.check.result.data.status",
          "right": "success"
        }
      },
      {
        "equals": {
          "left": "$.steps.check.result.data.status",
          "right": "completed"
        }
      }
    ]
  },
  "next": "process_done"
}
```

---

## RetryConfig (재시도)

```typescript
interface RetryConfig {
  attempts: number; // 최대 재시도 횟수
  delayMs?: number; // 재시도 간 지연
  backoff?: "linear" | "exponential"; // 백오프 전략
}
```

---

### 예시

**기본 재시도**:

```json
{
  "retry": {
    "attempts": 3,
    "delayMs": 1000
  }
}
```

**Exponential Backoff**:

```json
{
  "retry": {
    "attempts": 5,
    "delayMs": 1000,
    "backoff": "exponential"
  }
}
```

**재시도 간격**:

- Linear: 1초, 1초, 1초, 1초, 1초
- Exponential: 1초, 2초, 4초, 8초, 16초

---

## ParserConfig (출력 변환)

```typescript
interface ParserConfig {
  expression: string; // JSONPath 표현식
}
```

최종 워크플로우 출력을 변환합니다.

---

### 예시

**특정 스텝 결과 추출**:

```json
{
  "parser": {
    "expression": "$.steps.final_step.result.data"
  }
}
```

**여러 스텝 결과 병합**:

```json
{
  "parser": {
    "expression": "$merge([$.steps.step1.result.data, $.steps.step2.result.data])"
  }
}
```

---

## Variables (변수)

```typescript
vars?: Record<string, any>;   // 변수 정의
```

---

### 정적 변수

워크플로우 레벨에서 정의합니다.

**정의**:

```json
{
  "vars": {
    "userId": "12345",
    "apiKey": "abc123",
    "baseUrl": "https://api.example.com"
  }
}
```

**사용**:

```json
{
  "block": {
    "name": "fetch-api",
    "url": "${vars.baseUrl}/users/${vars.userId}",
    "headers": {
      "Authorization": "Bearer ${vars.apiKey}"
    }
  }
}
```

---

### 동적 변수 (JSONPath)

이전 스텝 결과를 참조합니다.

**예시**:

```json
{
  "block": {
    "name": "fetch-api",
    "url": "https://api.com/details/${$.steps.get_id.result.data}"
  }
}
```

---

### 컨텍스트 변수

루프 내에서 사용 가능한 변수입니다.

**forEach 변수**:

- `${$.forEach.item}`: 현재 아이템
- `${$.forEach.index}`: 현재 인덱스
- `${$.forEach.array}`: 전체 배열

**count 변수**:

- `${$.loop.index}`: 현재 반복 인덱스
- `${$.loop.count}`: 전체 반복 횟수

---

## 완전한 예시

```json
{
  "version": "1.0",
  "start": "login",
  "steps": [
    {
      "id": "login",
      "block": {
        "name": "keypress",
        "selector": "#email",
        "value": "${vars.email}"
      },
      "next": "submit"
    },
    {
      "id": "submit",
      "block": {
        "name": "event-click",
        "selector": "button[type=submit]"
      },
      "delayAfterMs": 2000,
      "retry": {
        "attempts": 3,
        "delayMs": 1000
      },
      "next": "check_result"
    },
    {
      "id": "check_result",
      "block": {
        "name": "element-exists",
        "selector": ".dashboard"
      },
      "switch": [
        {
          "when": {
            "equals": {
              "left": "$.steps.check_result.result.data.exists",
              "right": true
            }
          },
          "next": "extract_data"
        }
      ],
      "next": "handle_error"
    },
    {
      "id": "extract_data",
      "block": {
        "name": "get-element-data",
        "selector": ".data-row",
        "multiple": true,
        "fields": {
          "id": { "selector": ".id" },
          "name": { "selector": ".name" }
        }
      },
      "repeat": {
        "forEach": "$.steps.check_result.result.data.items"
      }
    }
  ],
  "targetUrl": "https://example.com",
  "parser": {
    "expression": "$.steps.extract_data.result.data"
  },
  "vars": {
    "email": "user@example.com"
  }
}
```

---

## 관련 문서

- [워크플로우 JSON 명세](../워크플로우-JSON-명세.md)
- [스텝 정의](./스텝-정의.md)
- [F-003: 조건부 분기](../../product-specs/F-003-조건부-분기.md)

---

**변경 이력**

| 버전 | 날짜       | 변경 내용                               | 작성자 |
| ---- | ---------- | --------------------------------------- | ------ |
| 1.0  | 2025-11-11 | 워크플로우 JSON 명세에서 고급 기능 분리 | System |
