# 시스템 아키텍처

**문서 버전**: 1.0
**최종 수정일**: 2025-11-11
**상위 문서**: [PRD](../PRD.md)

---

## 전체 시스템 구조

```
┌─────────────────────────────────────────────────────────────────┐
│                        사용자 인터페이스 계층                    │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────┐  │
│  │ 워크플로우   │  │ 플로우 빌더  │  │ 결과 대시보드        │  │
│  │ 목록         │  │              │  │                      │  │
│  └──────────────┘  └──────────────┘  └──────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                        애플리케이션 계층                         │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────┐  │
│  │WorkflowBuilder│  │WorkflowRunner│  │ 스키마 파서          │  │
│  └──────────────┘  └──────────────┘  └──────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                        데이터 접근 계층                          │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────┐  │
│  │ TypeORM      │  │ MySQL DB     │  │ External API        │  │
│  └──────────────┘  └──────────────┘  └──────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                        실행 계층                                 │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │          브라우저 확장 (scordi-extension)                  │  │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────┐   │  │
│  │  │ 워크플로우  │  │ DOM 자동화  │  │ 결과 수집       │   │  │
│  │  │ 엔진        │  │             │  │                 │   │  │
│  │  └─────────────┘  └─────────────┘  └─────────────────┘   │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 기술 스택 상세

### Frontend

**React 19**
- Concurrent Features
- Automatic Batching
- Suspense for Data Fetching

**React Router 7**
- Config-based Routing
- Server-Side Rendering
- Loader/Action 패턴
- Type-safe Parameters

**React Flow 12**
- 노드/엣지 가상화
- 커스텀 노드 타입
- 다양한 레이아웃 알고리즘

**UI 라이브러리**
- shadcn/ui: 프리빌트 컴포넌트
- Radix UI: 헤드리스 접근성 컴포넌트
- TailwindCSS 4: 유틸리티 CSS
- Lucide React: 아이콘

### Backend

**Express 5**
- HTTP 서버
- React Router SSR 통합
- WebSocket 지원

**TypeORM 0.3.27**
- Active Record 패턴
- JSON 컬럼 지원
- MySQL 드라이버

**Validation**
- Zod 3.25.76: 런타임 스키마 검증
- class-validator: DTO 검증

---

## 데이터 흐름

### 워크플로우 생성 플로우

```
사용자 액션 (노드 추가/연결)
  ↓
React Flow State 업데이트
  ↓
buildWorkflowJson(nodes, edges, targetUrl)
  ↓
FormWorkflow JSON 생성
  ↓
Zod 스키마 검증
  ↓
Route Action (Form 제출)
  ↓
upsertWorkflowMetadata(workflow)
  ↓
TypeORM Insert/Update
  ↓
MySQL 저장
  ↓
워크플로우 목록으로 리다이렉트
```

### 워크플로우 로드 플로우

```
사용자 요청 (/workflow-builder/:id)
  ↓
Route Loader 실행
  ↓
findWorkflowMetadata(id)
  ↓
TypeORM Query
  ↓
MySQL에서 JSON 조회
  ↓
FormWorkflow 파싱
  ↓
convertWorkflowToNodesAndEdges(workflow)
  ↓
{ nodes, edges } 생성
  ↓
Dagre 레이아웃 적용
  ↓
React Flow 렌더링
```

### 워크플로우 실행 플로우

```
사용자 "Run" 클릭
  ↓
buildWorkflowJson(nodes, edges, targetUrl)
  ↓
변수 치환 (${vars.varName})
  ↓
EightGClient.collectWorkflow()
  ↓
Chrome Extension Message Passing
  ↓
Extension: 새 탭 열기 (targetUrl)
  ↓
Extension: Content Script 주입
  ↓
각 스텝 순차 실행
  ├─ DOM 조작
  ├─ 데이터 추출
  ├─ API 호출
  └─ 조건부 분기
  ↓
결과 수집 및 컨텍스트 저장
  ↓
Extension → UI로 결과 반환
  ↓
ResultPanel에 표시
```

---

## 컴포넌트 아키텍처

### 계층 구조

```
app/
├── .server/              # 서버 전용 (클라이언트 번들 제외)
│   ├── db/              # TypeORM 설정 및 엔티티
│   ├── dto/             # Data Transfer Objects
│   └── services/        # 비즈니스 로직 서비스
│
├── models/              # 도메인 모델 (클라이언트/서버 공용)
│   ├── workflow/
│   │   ├── WorkflowBuilder.ts    # 그래프 → JSON 변환
│   │   ├── WorkflowRunner.ts     # 실행 오케스트레이션
│   │   └── types.ts              # 타입 정의
│   └── integration/
│
├── client/              # 페이지 레벨 컴포넌트
│   ├── admin/
│   │   └── workflowBuilder/     # 워크플로우 빌더 (57개 파일)
│   ├── private/
│   └── public/
│
├── components/          # 재사용 가능한 UI 컴포넌트
│   └── ui/             # shadcn/ui 컴포넌트
│
├── hooks/              # 커스텀 React 훅
├── lib/                # 유틸리티 라이브러리
├── routes/             # React Router 라우트
└── routes.ts           # 라우트 설정
```

---

## 네트워크 아키텍처

### API 엔드포인트

**Internal APIs** (React Router Actions/Loaders)
```
GET  /workflow-builder/:workflowId?  → Loader: 워크플로우 로드
POST /workflow-builder               → Action: 워크플로우 저장
GET  /workflows                      → Loader: 워크플로우 목록
POST /api/generate-jsonata           → API: JSONata 생성
```

**External APIs**
```
POST http://localhost:8000/8g/workflows       → 워크플로우 저장
GET  http://localhost:8000/products           → 제품 목록
```

### WebSocket 서버

```javascript
// server.js
const wss = new WebSocketServer({ server });

wss.on("connection", (ws) => {
  const clientId = generateClientId();

  ws.on("message", (data) => {
    const { type, payload } = JSON.parse(data);

    switch (type) {
      case "ping":
        ws.send(JSON.stringify({ type: "pong" }));
        break;

      case "broadcast":
        broadcastToClients(payload, clientId);
        break;
    }
  });
});
```

**사용 계획**: 실시간 협업, 실행 진행률 푸시

---

## 보안 아키텍처

### 서버-클라이언트 분리

```
app/.server/               app/client/
    ↓                         ↓
번들 제외                   번들 포함
    ↓                         ↓
민감 정보 처리              UI 로직
DB 연결                    사용자 인터랙션
API 키                     상태 관리
```

### 데이터 검증

```
사용자 입력
  ↓
클라이언트 Zod 검증
  ↓
서버 DTO 검증
  ↓
TypeORM 엔티티 검증
  ↓
MySQL 저장
```

---

## 확장성 고려사항

### 수평 확장

**현재**: 단일 Express 서버
**향후**: Load Balancer + 여러 서버 인스턴스

```
                Load Balancer
                      ↓
        ┌─────────────┼─────────────┐
        ↓             ↓             ↓
    Server 1      Server 2      Server 3
        ↓             ↓             ↓
                MySQL (공유)
```

### 데이터베이스 확장

**현재**: 단일 MySQL
**향후**: Read Replica + Cache

```
Application
    ↓
  Write → Master DB
    ↓
  Read → Replica 1, Replica 2
    ↓
  Cache → Redis
```

---

## 성능 최적화

### Frontend

- React Flow 가상화
- 코드 스플리팅 (React.lazy)
- 이미지 최적화
- 메모이제이션 (useMemo, useCallback)

### Backend

- TypeORM 쿼리 최적화
- JSON 컬럼 인덱싱
- 연결 풀링
- 캐싱 전략

### Network

- HTTP/2
- Gzip 압축
- CDN (정적 자산)

---

## 관련 문서

- [PRD](../PRD.md)
- [워크플로우 JSON 명세](./워크플로우-JSON-명세.md)
- [데이터 모델](./데이터-모델.md)

---

**변경 이력**

| 버전 | 날짜 | 변경 내용 | 작성자 |
|-----|------|---------|-------|
| 1.0 | 2025-11-11 | 최초 작성 | System |
