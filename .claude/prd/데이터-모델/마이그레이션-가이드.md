# 마이그레이션 가이드

**문서 버전**: 1.0
**최종 수정일**: 2025-11-11
**상위 문서**: [데이터 모델](../데이터-모델.md)

---

## 개요

이 문서는 8G 플랫폼의 데이터베이스 마이그레이션 절차와 버전 관리 방법을 설명합니다.

---

## 현재 상태

**마이그레이션 도구**: 미구현
**방식**: 수동 SQL 실행

현재 프로젝트는 자동화된 마이그레이션 도구를 사용하지 않습니다. 데이터베이스 스키마 변경은 수동으로 SQL을 실행하여 적용합니다.

---

## 수동 마이그레이션 절차

### 1. 초기 설정

새 환경에 데이터베이스를 설정하는 절차입니다.

**Step 1: 데이터베이스 생성**

```sql
CREATE DATABASE IF NOT EXISTS payplo_staging
  CHARACTER SET utf8mb4
  COLLATE utf8mb4_unicode_ci;
```

**Step 2: 사용자 권한 설정**

```sql
GRANT ALL PRIVILEGES ON payplo_staging.* TO 'myuser'@'localhost';
FLUSH PRIVILEGES;
```

**Step 3: 테이블 생성**

```sql
USE payplo_staging;

CREATE TABLE IF NOT EXISTS integration_app_workflow_metadata (
  id INT NOT NULL AUTO_INCREMENT,
  description VARCHAR(255),
  meta JSON NOT NULL,
  created_at DATETIME(6) DEFAULT CURRENT_TIMESTAMP(6),
  updated_at DATETIME(6) DEFAULT CURRENT_TIMESTAMP(6) ON UPDATE CURRENT_TIMESTAMP(6),
  PRIMARY KEY (id),
  INDEX idx_created_at (created_at),
  INDEX idx_updated_at (updated_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

---

### 2. 환경 설정

`.env` 파일 설정:

```env
DB_HOST=localhost
DB_PORT=3306
DB_USER=myuser
DB_PASSWORD=mypassword
DB_NAME=payplo_staging
```

---

### 3. TypeORM 엔티티 생성

스키마 변경 후 TypeORM 엔티티를 재생성합니다.

```bash
pnpm run db:generate-entities
```

**참고**: 현재 이 명령어는 구현되어 있지 않을 수 있습니다.

---

## 스키마 변경 절차

### 컬럼 추가

**예시: workspace_id 컬럼 추가**

```sql
ALTER TABLE integration_app_workflow_metadata
  ADD COLUMN workspace_id INT NULL AFTER description,
  ADD INDEX idx_workspace_id (workspace_id);
```

**TypeORM 엔티티 업데이트**:

```typescript
@Entity("integration_app_workflow_metadata")
export class IntegrationAppWorkflowMetadata {
  // 기존 컬럼...

  @Column({ type: "int", nullable: true })
  workspace_id?: number;
}
```

---

### 인덱스 추가

```sql
CREATE INDEX idx_column_name
  ON integration_app_workflow_metadata(column_name);
```

---

### 테이블 추가

**예시: 실행 이력 테이블**

```sql
CREATE TABLE IF NOT EXISTS workflow_execution_history (
  id INT NOT NULL AUTO_INCREMENT,
  workflow_id INT NOT NULL,
  result JSON NOT NULL,
  success BOOLEAN NOT NULL,
  execution_time_ms INT,
  executed_at DATETIME(6) DEFAULT CURRENT_TIMESTAMP(6),
  PRIMARY KEY (id),
  FOREIGN KEY (workflow_id)
    REFERENCES integration_app_workflow_metadata(id)
    ON DELETE CASCADE,
  INDEX idx_workflow_id (workflow_id),
  INDEX idx_executed_at (executed_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

---

## 데이터 마이그레이션

### JSON 구조 변경

meta 컬럼의 JSON 구조를 변경할 때:

```sql
-- 백업 생성
CREATE TABLE integration_app_workflow_metadata_backup
  AS SELECT * FROM integration_app_workflow_metadata;

-- JSON 구조 업데이트 (예: version 필드 추가)
UPDATE integration_app_workflow_metadata
SET meta = JSON_SET(meta, '$.version', '1.0')
WHERE JSON_EXTRACT(meta, '$.version') IS NULL;
```

---

### 데이터 검증

```sql
-- 모든 레코드가 version 필드를 가지고 있는지 확인
SELECT COUNT(*) AS missing_version
FROM integration_app_workflow_metadata
WHERE JSON_EXTRACT(meta, '$.version') IS NULL;
```

---

## 롤백 절차

### 1. 백업에서 복구

```sql
-- 테이블 삭제
DROP TABLE integration_app_workflow_metadata;

-- 백업에서 복구
RENAME TABLE integration_app_workflow_metadata_backup
  TO integration_app_workflow_metadata;
```

---

### 2. 컬럼 삭제

```sql
ALTER TABLE integration_app_workflow_metadata
  DROP COLUMN workspace_id;
```

---

## 버전 관리

### 마이그레이션 파일 명명 규칙

향후 마이그레이션 도구 도입 시 사용할 명명 규칙:

```
migrations/
  ├── V001__create_workflow_metadata_table.sql
  ├── V002__add_workspace_id_column.sql
  ├── V003__create_execution_history_table.sql
  └── V004__add_version_to_workflow_json.sql
```

**형식**: `V{번호}__{설명}.sql`

---

### 버전 추적 테이블 (향후 계획)

```sql
CREATE TABLE schema_version (
  version INT NOT NULL,
  description VARCHAR(255) NOT NULL,
  applied_at DATETIME(6) DEFAULT CURRENT_TIMESTAMP(6),
  PRIMARY KEY (version)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

---

## 자동화 마이그레이션 도구 (향후 계획)

### Flyway 도입 계획

**장점**:
- SQL 기반 마이그레이션
- 버전 관리 자동화
- 롤백 지원

**설정 예시** (`flyway.conf`):

```properties
flyway.url=jdbc:mysql://localhost:3306/payplo_staging
flyway.user=myuser
flyway.password=mypassword
flyway.locations=filesystem:./migrations
```

---

### TypeORM Migrations 도입 계획

**장점**:
- TypeScript로 마이그레이션 작성
- 엔티티와 동기화
- CLI 도구 제공

**설정 예시** (`ormconfig.json`):

```json
{
  "type": "mysql",
  "host": "localhost",
  "port": 3306,
  "username": "myuser",
  "password": "mypassword",
  "database": "payplo_staging",
  "entities": ["app/.server/db/entities/**/*.ts"],
  "migrations": ["migrations/**/*.ts"],
  "cli": {
    "migrationsDir": "migrations"
  }
}
```

**사용법**:

```bash
# 마이그레이션 생성
npx typeorm migration:create -n CreateWorkflowTable

# 마이그레이션 실행
npx typeorm migration:run

# 롤백
npx typeorm migration:revert
```

---

## 관련 문서

- [데이터 모델](../데이터-모델.md)
- [데이터베이스 스키마](./데이터베이스-스키마.md)

---

**변경 이력**

| 버전 | 날짜 | 변경 내용 | 작성자 |
|-----|------|---------|-------|
| 1.0 | 2025-11-11 | 데이터 모델에서 마이그레이션 부분 분리 | System |
