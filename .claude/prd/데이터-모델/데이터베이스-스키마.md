# 데이터베이스 스키마

**문서 버전**: 1.0
**최종 수정일**: 2025-11-11
**상위 문서**: [데이터 모델](../데이터-모델.md)

---

## 개요

이 문서는 8G 플랫폼의 데이터베이스 테이블 스키마와 ERD를 정의합니다.

---

## 테이블: integration_app_workflow_metadata

### 목적

워크플로우 메타데이터 및 정의를 저장하는 핵심 테이블입니다.

---

### DDL

```sql
CREATE TABLE IF NOT EXISTS integration_app_workflow_metadata (
  id INT NOT NULL AUTO_INCREMENT,
  description VARCHAR(255),
  meta JSON NOT NULL,
  created_at DATETIME(6) DEFAULT CURRENT_TIMESTAMP(6),
  updated_at DATETIME(6) DEFAULT CURRENT_TIMESTAMP(6) ON UPDATE CURRENT_TIMESTAMP(6),
  PRIMARY KEY (id),
  INDEX idx_created_at (created_at),
  INDEX idx_updated_at (updated_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

---

### 컬럼 정의

| 컬럼명      | 타입         | NULL | 기본값            | 설명                                     |
| ----------- | ------------ | ---- | ----------------- | ---------------------------------------- |
| id          | INT          | NO   | AUTO_INCREMENT    | 워크플로우 고유 ID                       |
| description | VARCHAR(255) | YES  | NULL              | 워크플로우 설명                          |
| meta        | JSON         | NO   | -                 | 워크플로우 JSON 정의 (FormWorkflow 구조) |
| created_at  | DATETIME(6)  | NO   | CURRENT_TIMESTAMP | 생성 시각 (마이크로초 정밀도)            |
| updated_at  | DATETIME(6)  | NO   | CURRENT_TIMESTAMP | 수정 시각 (자동 갱신)                    |

---

### 인덱스

**PRIMARY KEY**: id

- 워크플로우 고유 식별자
- Auto Increment로 자동 증가

**INDEX**: idx_created_at

- 최근 생성된 워크플로우 조회 최적화
- 사용: `ORDER BY created_at DESC`

**INDEX**: idx_updated_at

- 최근 수정된 워크플로우 조회 최적화
- 사용: `ORDER BY updated_at DESC`

---

### meta 컬럼 구조

meta 컬럼은 FormWorkflow 타입의 JSON 객체를 저장합니다.

```typescript
interface FormWorkflow {
  version: string; // "1.0"
  start: string; // 시작 스텝 ID
  steps: WorkflowStep[]; // 워크플로우 스텝 배열
  targetUrl?: string; // 타겟 웹사이트 URL
  parser?: ParserConfig; // 출력 변환 설정
  vars?: Record<string, any>; // 변수 정의
}
```

---

## TypeORM 엔티티

### IntegrationAppWorkflowMetadata

**파일 위치**: `app/.server/db/entities/IntegrationAppWorkflowMetadata.ts`

```typescript
import {
  Entity,
  PrimaryGeneratedColumn,
  Column,
  CreateDateColumn,
  UpdateDateColumn,
} from "typeorm";
import { FormWorkflow } from "~/models/workflow/types";

@Entity("integration_app_workflow_metadata")
export class IntegrationAppWorkflowMetadata {
  @PrimaryGeneratedColumn()
  id!: number;

  @Column({ type: "varchar", length: 255, nullable: true })
  description?: string;

  @Column({ type: "json" })
  meta!: FormWorkflow;

  @CreateDateColumn({ type: "datetime", precision: 6 })
  created_at!: Date;

  @UpdateDateColumn({ type: "datetime", precision: 6 })
  updated_at!: Date;
}
```

---

### 특징

**Active Record 패턴**:

- TypeORM의 Active Record 패턴 사용
- 엔티티 클래스에서 직접 CRUD 메소드 호출 가능

**JSON 컬럼 활용**:

- 복잡한 워크플로우 구조를 유연하게 저장
- 스키마 변경 없이 워크플로우 구조 확장 가능

**자동 타임스탬프**:

- @CreateDateColumn: 생성 시 자동 설정
- @UpdateDateColumn: 수정 시 자동 갱신

---

## 저장 예시

### 데이터베이스 레코드

```json
{
  "id": 1,
  "description": "경쟁사 가격 수집 워크플로우",
  "meta": {
    "version": "1.0",
    "start": "extract_products",
    "steps": [
      {
        "id": "extract_products",
        "block": {
          "name": "get-element-data",
          "selector": ".product",
          "findBy": "cssSelector",
          "multiple": true,
          "fields": {
            "name": { "selector": ".product-name" },
            "price": { "selector": ".product-price" }
          }
        },
        "next": "transform_data"
      },
      {
        "id": "transform_data",
        "block": {
          "name": "transform-data",
          "sourceData": "$.steps.extract_products.result.data",
          "expression": "*.{ name: name, price: $number(price) }"
        }
      }
    ],
    "targetUrl": "https://competitor.com/products",
    "parser": {
      "expression": "$.steps.transform_data.result.data"
    }
  },
  "created_at": "2025-11-11T10:00:00.000000",
  "updated_at": "2025-11-11T10:30:00.000000"
}
```

---

## ERD (Entity Relationship Diagram)

현재는 단일 테이블 구조입니다.

```
┌─────────────────────────────────────────┐
│ integration_app_workflow_metadata       │
├─────────────────────────────────────────┤
│ PK  id: INT                            │
│     description: VARCHAR(255) NULL     │
│     meta: JSON                         │
│     created_at: DATETIME(6)            │
│     updated_at: DATETIME(6)            │
└─────────────────────────────────────────┘
```

---

## 향후 테이블 추가 계획

### workflow_execution_history (계획)

워크플로우 실행 이력을 저장하는 테이블입니다.

```sql
CREATE TABLE workflow_execution_history (
  id INT NOT NULL AUTO_INCREMENT,
  workflow_id INT NOT NULL,
  result JSON NOT NULL,
  success BOOLEAN NOT NULL,
  execution_time_ms INT,
  executed_at DATETIME(6) DEFAULT CURRENT_TIMESTAMP(6),
  PRIMARY KEY (id),
  FOREIGN KEY (workflow_id) REFERENCES integration_app_workflow_metadata(id),
  INDEX idx_workflow_id (workflow_id),
  INDEX idx_executed_at (executed_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

---

## 관련 문서

- [데이터 모델](../데이터-모델.md)
- [마이그레이션 가이드](./마이그레이션-가이드.md)
- [워크플로우 JSON 명세](../워크플로우-JSON-명세.md)

---

**변경 이력**

| 버전 | 날짜       | 변경 내용                        | 작성자 |
| ---- | ---------- | -------------------------------- | ------ |
| 1.0  | 2025-11-11 | 데이터 모델에서 스키마 부분 분리 | System |
